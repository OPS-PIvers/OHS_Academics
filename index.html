<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHS Academics & Attendance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #2d3f89; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; }
        .kpi-card { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .kpi-value { font-size: 2.5rem; font-weight: 700; color: #2d3f89; }
        .kpi-label { font-size: 1rem; font-weight: 500; color: #4b5563; }
        .ineligible-text { color: #ef4444; font-weight: 600; }
        .eligible-text { color: #22c55e; font-weight: 600; }
        .filter-btn { padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: white; color: #374151; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover { background-color: #f3f4f6; }
        .filter-btn.active { background-color: #2d3f89; color: white; border-color: #2d3f89; }
        select.filter-select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
            padding: 0.5rem 2.5rem 0.5rem 0.75rem;
            border-radius: 0.5rem; border: 1px solid #d1d5db;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        select.filter-select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); }
        .fixed-table { table-layout: fixed; width: 100%; }
        th[data-sort] { cursor: pointer; }
        .sort-icon { color: #9ca3af; font-size: 0.9em; vertical-align: middle; }
        .tooltip-trigger, .kpi-card.clickable { cursor: pointer; }
        .header-title { text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5); }
        .header-subtitle { text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.4); }
        /* Tooltip Styles */
        #tooltip {
            position: absolute; display: none;
            background-color: #111827; color: white;
            padding: 0.75rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 0.875rem; max-width: 300px;
            z-index: 1000;
            transition: opacity 0.2s;
        }
        #tooltip h4 { font-weight: 600; margin-bottom: 0.5rem; border-bottom: 1px solid #4b5563; padding-bottom: 0.5rem;}
        #tooltip ul { list-style: none; padding-left: 0; }
        #tooltip li { margin-top: 0.5rem; display: flex; justify-content: space-between; }
        #tooltip li span:first-child { color: #d1d5db; padding-right: 1rem; }
        .ineligible-row { background-color: #fee2e2; } /* Light red for ineligible students */
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div id="tooltip"></div>
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-white header-title tracking-tight">OHS Academics & Attendance Dashboard</h1>
            <p class="text-gray-300 mt-2 header-subtitle">Visual analysis of student performance and attendance.</p>
        </header>

        <div id="loading-state" class="text-center py-16 bg-white rounded-lg">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-gray-600 font-medium">Loading and processing student data...</p>
        </div>

        <main id="dashboard-content" class="hidden">
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-students" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-white border-white">Student List</button>
                    <button id="tab-visuals" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-400 border-transparent hover:text-white hover:border-gray-300">Data Visualizations</button>
                    <button id="tab-historical" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-400 border-transparent hover:text-white hover:border-gray-300">Historical Trends</button>
                </nav>
            </div>

            <div id="tab-content-students">
                <div class="card mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Student Lookup Filters</h2>
                        <button id="reset-student-filters-btn" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition">Clear Filters</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="student-search" placeholder="Search by student name..." class="w-full p-2 border border-gray-300 rounded-lg">
                        <div>
                            <label for="student-activity-filter" class="sr-only">Filter by Activity</label>
                            <select id="student-activity-filter" class="filter-select w-full"></select>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                         <div id="student-grade-filters" class="flex flex-wrap items-center gap-2"><span class="font-medium text-gray-600">Grade:</span><button class="filter-btn active" data-grade="all">All</button><button class="filter-btn" data-grade="9">9</button><button class="filter-btn" data-grade="10">10</button><button class="filter-btn" data-grade="11">11</button><button class="filter-btn" data-grade="12">12</button></div>
                        <div id="student-eligibility-filters" class="flex flex-wrap items-center gap-2"><span class="font-medium text-gray-600">Status:</span><button class="filter-btn active" data-status="all">All</button><button class="filter-btn" data-status="ineligible">Ineligible</button><button class="filter-btn" data-status="eligible">Eligible</button></div>
                    </div>
                    <div class="overflow-x-auto"><table class="fixed-table"><thead class="bg-gray-50 sticky top-0 z-10"><tr><th class="w-1/12 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="grade">Grade <span class="sort-icon"></span></th><th class="w-2/12 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="studentName">Student Name <span class="sort-icon"></span></th><th class="w-2/12 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activities</th><th class="w-1/12 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="numFGrades">Failing <span class="sort-icon"></span></th><th class="w-1/12 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="unservedDetention">Detention <span class="sort-icon"></span></th><th class="w-1/12 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="totalAbsences">Absences <span class="sort-icon"></span></th><th class="w-2/12 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Spartan Hour</th></tr></thead><tbody id="student-list" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                    <div id="no-students-message" class="text-center py-8 text-gray-500 hidden">No students match the current filters.</div>
                </div>
            </div>

            <div id="tab-content-visuals" class="hidden">
                 <div class="card mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Global Dashboard Filters</h2>
                        <button id="reset-global-filters-btn" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition">Clear Filters</button>
                    </div>
                    <div id="global-filters" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="grade-filter" class="block text-sm font-medium text-gray-700 mb-1">Grade Level</label>
                            <select id="grade-filter" class="filter-select w-full"><option value="all">All Grades</option><option value="9">Grade 9</option><option value="10">Grade 10</option><option value="11">Grade 11</option><option value="12">Grade 12</option></select>
                        </div>
                        <div>
                            <label for="sped-filter" class="block text-sm font-medium text-gray-700 mb-1">Student Group</label>
                            <select id="sped-filter" class="filter-select w-full"><option value="all">All Students</option><option value="sped">Special Education</option><option value="gened">General Education</option><option value="tier2">Tier 2</option></select>
                        </div>
                        <div>
                            <label for="activity-filter" class="block text-sm font-medium text-gray-700 mb-1">Activity / Team</label>
                            <select id="activity-filter" class="filter-select w-full"><option value="all">All Activities</option></select>
                        </div>
                        <div id="counselor-group-filter-container" class="hidden">
                            <label for="counselor-group-filter" class="block text-sm font-medium text-gray-700 mb-1">My Caseload</label>
                            <select id="counselor-group-filter" class="filter-select w-full">
                                <option value="my">My Alpha Students</option>
                                <option value="all">All Students</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <div id="kpi-total-students-card" class="card kpi-card"><div id="total-students" class="kpi-value">0</div><div class="kpi-label">Total Students</div></div>
                    <div id="kpi-ineligible-students-card" class="card kpi-card"><div id="ineligible-students" class="kpi-value">0</div><div class="kpi-label">Ineligible Students</div></div>
                    <div id="kpi-ineligibility-rate-card" class="card kpi-card"><div id="ineligibility-rate" class="kpi-value">0%</div><div class="kpi-label">Ineligibility Rate</div></div>
                    <div id="kpi-avg-absences-card" class="card kpi-card"><div id="avg-absences" class="kpi-value">0</div><div class="kpi-label">Avg. Absences (Periods)</div></div>
                    <div id="kpi-total-f-grades-card" class="card kpi-card"><div id="total-f-grades" class="kpi-value">0</div><div class="kpi-label">Total F Grades</div></div>
                    <div id="kpi-spartan-total-requests-card" class="card kpi-card"><div id="spartan-total-requests" class="kpi-value">0</div><div class="kpi-label">Spartan Hour Total Requests</div></div>
                    <div id="kpi-spartan-skipped-requests-card" class="card kpi-card"><div id="spartan-skipped-requests" class="kpi-value">0</div><div class="kpi-label">Spartan Hour Skipped Requests</div></div>
                    <div id="kpi-spartan-high-priority-requests-card" class="card kpi-card"><div id="spartan-high-priority-requests" class="kpi-value">0</div><div class="kpi-label">Spartan Hour High Priority Requests</div></div>
                    <div id="kpi-df-no-request-card" class="card kpi-card"><div id="df-no-request" class="kpi-value">0</div><div id="df-no-request-label" class="kpi-label">D/F List No Request</div></div>
                    <div id="kpi-total-students-with-club-meetings-card" class="card kpi-card"><div id="total-students-with-club-meetings" class="kpi-value">0</div><div class="kpi-label">Club Participation</div></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Absence Breakdown by Type</h2><div class="chart-container"><canvas id="attendance-breakdown-chart"></canvas></div></div>
                    <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Ineligibility Reasons</h2><div class="chart-container"><canvas id="ineligibility-chart"></canvas></div></div>
                    <div class="card lg:col-span-2"><h2 class="text-xl font-semibold text-gray-700 mb-4">Average Absences by Number of Failing Grades</h2><div class="chart-container"><canvas id="correlation-chart"></canvas></div></div>
                    <div class="card lg:col-span-2"><h2 class="text-xl font-semibold text-gray-700 mb-4">Performance: Activity vs. Non-Activity Students</h2><div class="chart-container"><canvas id="activity-chart"></canvas></div></div>
                    <div class="card lg:col-span-2"><h2 class="text-xl font-semibold text-gray-700 mb-4">Spartan Hour Request Breakdown</h2><div class="chart-container"><canvas id="spartan-hour-chart"></canvas></div></div>
                    <div class="card lg:col-span-2"><h2 class="text-xl font-semibold text-gray-700 mb-4">Club Participation by Grade</h2><div class="chart-container"><canvas id="club-meetings-by-grade-chart"></canvas></div></div>
                </div>
            </div>

            <div id="tab-content-historical" class="hidden">
                <div class="card mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Historical Snapshot Management</h2>
                        <button id="create-snapshot-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition" aria-label="Create Snapshot Now">Create Snapshot Now</button>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Snapshots are automatically captured every Monday at 11:00 AM before the Tuesday data updates. View trends and compare data week-over-week.</p>
                    <!-- Inline notification message div -->
                    <div id="snapshot-message" class="hidden mb-4 p-4 rounded-lg" role="alert" aria-live="polite"></div>
                    <div id="snapshot-info" class="text-sm text-gray-700"></div>
                </div>

                <div class="card mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Week-Over-Week Comparison</h2>
                    <!-- Inline validation message div -->
                    <div id="comparison-message" class="hidden mb-4 p-3 rounded-lg" role="alert" aria-live="polite"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="comparison-date-1" class="block text-sm font-medium text-gray-700 mb-1">Select First Week</label>
                            <select id="comparison-date-1" class="filter-select w-full" aria-label="Select first snapshot date for comparison">
                                <option value="">Select a snapshot date...</option>
                            </select>
                        </div>
                        <div>
                            <label for="comparison-date-2" class="block text-sm font-medium text-gray-700 mb-1">Select Second Week</label>
                            <select id="comparison-date-2" class="filter-select w-full" aria-label="Select second snapshot date for comparison">
                                <option value="">Select a snapshot date...</option>
                            </select>
                        </div>
                    </div>
                    <button id="compare-snapshots-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition" aria-label="Compare selected snapshots">Compare Snapshots</button>
                    <div id="comparison-results" class="mt-4"></div>
                </div>

                <div id="historical-charts-container" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Students with Failing Grades Over Time</h2><div class="chart-container"><canvas id="historical-failing-chart"></canvas></div></div>
                        <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Average Absences Over Time</h2><div class="chart-container"><canvas id="historical-absences-chart"></canvas></div></div>
                        <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Unserved Detention Over Time</h2><div class="chart-container"><canvas id="historical-detention-chart"></canvas></div></div>
                        <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Ineligibility Rate Over Time</h2><div class="chart-container"><canvas id="historical-ineligibility-chart"></canvas></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Role and user info will be populated from the server response
        let USER_ROLE = '<?= userRole ?>'; // Initial role for UI setup
        let USER_NAME = '<?= userName ?>';
        let USER_EMAIL = '<?= userEmail ?>';
        let USER_ALPHA_START = '';
        let USER_ALPHA_END = '';
        let dfNoRequestDate = 'N/A';
        let allStudentData = [], allStudentsAnonymized = [], charts = {}, studentListFilters = { search: '', grade: 'all', eligibility: 'all', activity: 'all' }, studentListSort = { key: 'studentName', order: 'asc' }, globalFilters = { grade: 'all', sped: 'all', activity: 'all', counselorGroup: 'my' };
        let baselineKPIs = {};
        let historicalData = null;
        let aggregatedData = null;
        const tooltip = document.getElementById('tooltip');

        document.addEventListener('DOMContentLoaded', () => {
            // Apply role-based UI restrictions before loading data
            applyRoleBasedUI();

            // Single data-loading call for all roles
            google.script.run
                .withSuccessHandler(initializeDashboard)
                .withFailureHandler(handleError)
                .getStudentDataForWebApp();
        });

        function applyRoleBasedUI() {
            if (USER_ROLE === 'TEACHER') {
                // Hide Student List and Historical Trends tabs for TEACHERs
                document.getElementById('tab-students').style.display = 'none';
                document.getElementById('tab-historical').style.display = 'none';

                // Remove active styling from Student List tab (default)
                const tabStudents = document.getElementById('tab-students');
                tabStudents.classList.remove('text-white', 'border-white');
                tabStudents.classList.add('text-gray-400', 'border-transparent');

                // Set Data Visualizations as default active tab
                const tabVisuals = document.getElementById('tab-visuals');
                tabVisuals.classList.add('text-white', 'border-white');
                tabVisuals.classList.remove('text-gray-400', 'border-transparent');
            }

            if (USER_ROLE === 'COUNSELOR') {
                // Hide Historical Trends tab for COUNSELORs
                document.getElementById('tab-historical').style.display = 'none';
                // Show the counselor caseload filter in Data Viz
                document.getElementById('counselor-group-filter-container').classList.remove('hidden');
                // Update grid to 4 columns to accommodate the new filter
                const globalFiltersDiv = document.getElementById('global-filters');
                globalFiltersDiv.classList.remove('md:grid-cols-3');
                globalFiltersDiv.classList.add('md:grid-cols-4');
            }
        }
        
        function initializeDashboard(response) {
            const { user, students, aggregatedStats, allStudentsAnonymized: anonymizedData } = response;

            // Set global user variables from the detailed object
            USER_ROLE = user.role;
            USER_NAME = user.name;
            USER_EMAIL = user.email;
            USER_ALPHA_START = user.alphaStart || '';
            USER_ALPHA_END = user.alphaEnd || '';

            if (response.dfNoRequestDate) {
                dfNoRequestDate = response.dfNoRequestDate;
            }

            // Re-apply role-based UI now that we have full user info
            applyRoleBasedUI();

            // Explicitly set default view for TEACHER role
            if (USER_ROLE === 'TEACHER') {
                document.getElementById('tab-content-students').classList.add('hidden');
                document.getElementById('tab-content-visuals').classList.remove('hidden');
            }

            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');

            // Handle aggregated-only data (TEACHER role)
            if (aggregatedStats) {
                aggregatedData = aggregatedStats;
                setupTabs();
                renderKPIsFromAggregated(aggregatedStats.kpis);
                renderChartsFromAggregated(aggregatedStats.chartData);

                // Show Data Viz tab by default for teachers
                document.getElementById('tab-content-students').classList.add('hidden');
                document.getElementById('tab-content-visuals').classList.remove('hidden');
                return;
            }

            // Normal flow for ADMIN/COUNSELOR with student data
            allStudentData = students;

            // Store anonymized full-school data for counselors
            if (anonymizedData) {
                allStudentsAnonymized = anonymizedData;
                // Use anonymized data for school-wide baseline KPIs
                baselineKPIs = calculateGroupKPIs(allStudentsAnonymized);
            } else {
                baselineKPIs = calculateGroupKPIs(allStudentData);
            }

            populateFilters();
            setupGlobalFilters();
            setupStudentListFilters();
            setupSorting();
            setupTooltips();
            setupClearButtons();
            setupTabs();

            updateDashboard();
            applyStudentListFilters();
            updateSortIcons();
        }

        function setupTabs() {
            const tabStudents = document.getElementById('tab-students');
            const tabVisuals = document.getElementById('tab-visuals');
            const tabHistorical = document.getElementById('tab-historical');
            const contentStudents = document.getElementById('tab-content-students');
            const contentVisuals = document.getElementById('tab-content-visuals');
            const contentHistorical = document.getElementById('tab-content-historical');

            const switchTab = (activeTab, activeContent) => {
                [tabStudents, tabVisuals, tabHistorical].forEach(tab => {
                    const isActive = tab === activeTab;
                    tab.classList.toggle('text-white', isActive);
                    tab.classList.toggle('border-white', isActive);
                    tab.classList.toggle('text-gray-400', !isActive);
                    tab.classList.toggle('border-transparent', !isActive);
                    tab.classList.toggle('hover:text-white', !isActive);
                    tab.classList.toggle('hover:border-gray-300', !isActive);
                });
                [contentStudents, contentVisuals, contentHistorical].forEach(content => {
                    content.classList.toggle('hidden', content !== activeContent);
                });
            };

            tabStudents.addEventListener('click', () => switchTab(tabStudents, contentStudents));
            tabVisuals.addEventListener('click', () => switchTab(tabVisuals, contentVisuals));
            tabHistorical.addEventListener('click', () => {
                switchTab(tabHistorical, contentHistorical);
                if (!historicalData) {
                    loadHistoricalData();
                }
            });
        }

        function handleError(error) { console.error("Dashboard Error:", error); document.getElementById('loading-state').innerHTML = `<p class="text-red-500 font-semibold">Error loading data.</p><p class="text-gray-600 mt-2">Please ensure the sheet '‚≠êAcademics & Attendance Hub' exists and you have permission.</p>`; }

        function calculateGroupKPIs(data) {
            const totalStudents = data.length;
            if (totalStudents === 0) return { totalStudents: 0, ineligibleStudents: 0, ineligibilityRate: 0, avgAbsences: 0, totalFGrades: 0, spartanHourTotalRequests: 0, spartanHourSkippedRequests: 0, spartanHourReqsHighPriority: 0, totalStudentsWithClubMeetings: 0 };
            
            const ineligibleStudents = data.filter(s => s.ineligible).length;
            const totalAbsences = data.reduce((sum, s) => sum + s.totalAbsences, 0);
            const totalFGrades = data.reduce((sum, s) => sum + s.numFGrades, 0);
            const spartanHourTotalRequests = data.reduce((sum, s) => sum + s.spartanHourTotalRequests, 0);
            const spartanHourSkippedRequests = data.reduce((sum, s) => sum + s.spartanHourSkippedRequests, 0);
            const spartanHourReqsHighPriority = data.reduce((sum, s) => sum + s.spartanHourReqsHighPriority, 0);
            const dfNoRequestCount = data.filter(s => s.isOnDFNoRequestList).length;

            return {
                totalStudents: totalStudents,
                ineligibleStudents: ineligibleStudents,
                ineligibilityRate: (ineligibleStudents / totalStudents) * 100,
                avgAbsences: totalAbsences / totalStudents,
                totalFGrades: totalFGrades,
                spartanHourTotalRequests: spartanHourTotalRequests,
                spartanHourSkippedRequests: spartanHourSkippedRequests,
                spartanHourReqsHighPriority: spartanHourReqsHighPriority,
                totalStudentsWithClubMeetings: data.filter(s => s.totalClubMeetingsAttended > 0 || (s.clubsAttended && s.clubsAttended.trim() !== '')).length,
                dfNoRequestCount: dfNoRequestCount
            };
        }

        function populateFilters() {
            const activities = new Set(allStudentData.flatMap(s => (s.activity || '').split(',').map(a => a.trim()).filter(Boolean)));
            const sortedActivities = [...activities].sort();
            
            const globalActivityFilter = document.getElementById('activity-filter');
            sortedActivities.forEach(a => globalActivityFilter.innerHTML += `<option value="${a}">${a}</option>`);
            
            const studentActivityFilter = document.getElementById('student-activity-filter');
            studentActivityFilter.innerHTML = '<option value="all">Filter by Activity / Team</option>';
            sortedActivities.forEach(a => studentActivityFilter.innerHTML += `<option value="${a}">${a}</option>`);
        }

        function setupGlobalFilters() {
            document.getElementById('global-filters').addEventListener('change', e => {
                const { id, value } = e.target;
                if (id === 'grade-filter') globalFilters.grade = value;
                if (id === 'sped-filter') globalFilters.sped = value;
                if (id === 'activity-filter') globalFilters.activity = value;
                if (id === 'counselor-group-filter') globalFilters.counselorGroup = value;
                updateDashboard();
            });
        }
        
        function updateDashboard() {
            // Select base dataset based on counselor toggle
            let data;
            if (USER_ROLE === 'COUNSELOR' && globalFilters.counselorGroup === 'all') {
                // Use anonymized full-school data
                data = [...allStudentsAnonymized];
            } else {
                // Use alpha students (or all students for ADMIN)
                data = [...allStudentData];
            }

            if (globalFilters.grade !== 'all') data = data.filter(s => s.grade == globalFilters.grade);
            if (globalFilters.sped === 'sped') data = data.filter(s => s.caseManager);
            if (globalFilters.sped === 'gened') data = data.filter(s => !s.caseManager);
            if (globalFilters.sped === 'tier2') data = data.filter(s => s.tier2Interventions && s.tier2Interventions.trim() !== '');
            if (globalFilters.activity !== 'all') data = data.filter(s => (s.activity || '').split(',').map(a => a.trim()).includes(globalFilters.activity));

            renderKPIs(data);
            renderCharts(data);
        }

        function renderKPIs(data) {
            const filtersActive = Object.values(globalFilters).some(v => v !== 'all');
            const currentKPIs = calculateGroupKPIs(data);

            document.getElementById('total-students').textContent = currentKPIs.totalStudents;
            document.getElementById('ineligible-students').textContent = currentKPIs.ineligibleStudents;
            document.getElementById('ineligibility-rate').textContent = `${currentKPIs.ineligibilityRate.toFixed(1)}%`;
            document.getElementById('avg-absences').textContent = currentKPIs.avgAbsences.toFixed(1);
            document.getElementById('total-f-grades').textContent = currentKPIs.totalFGrades;
            document.getElementById('spartan-total-requests').textContent = currentKPIs.spartanHourTotalRequests;
            document.getElementById('spartan-skipped-requests').textContent = currentKPIs.spartanHourSkippedRequests;
            document.getElementById('spartan-high-priority-requests').textContent = currentKPIs.spartanHourReqsHighPriority;
            document.getElementById('df-no-request').textContent = currentKPIs.dfNoRequestCount;
            document.getElementById('df-no-request-label').textContent = `D/F List No Request (${dfNoRequestDate})`;
            document.getElementById('total-students-with-club-meetings').textContent = currentKPIs.totalStudentsWithClubMeetings;

            const kpiCardInfo = [
                { id: 'kpi-ineligibility-rate-card', key: 'ineligibilityRate' },
                { id: 'kpi-avg-absences-card', key: 'avgAbsences' },
                { id: 'kpi-total-students-card', key: 'totalStudents' },
                { id: 'kpi-ineligible-students-card', key: 'ineligibleStudents' },
                { id: 'kpi-total-f-grades-card', key: 'totalFGrades' },
                { id: 'kpi-spartan-total-requests-card', key: 'spartanHourTotalRequests' },
                { id: 'kpi-spartan-skipped-requests-card', key: 'spartanHourSkippedRequests' },
                { id: 'kpi-spartan-high-priority-requests-card', key: 'spartanHourReqsHighPriority' },
                { id: 'kpi-df-no-request-card', key: 'dfNoRequestCount' },
                { id: 'kpi-total-students-with-club-meetings-card', key: 'totalStudentsWithClubMeetings' }
            ];

            kpiCardInfo.forEach(card => {
                const cardEl = document.getElementById(card.id);
                cardEl.classList.remove('clickable');
                if (filtersActive || card.key === 'dfNoRequestCount') {
                    cardEl.classList.add('clickable');
                    cardEl.dataset.tooltipKey = card.key;
                }
            });
        }

        function generateComparisonTooltip(kpiKey) {
            const formatter = (v) => {
                if (kpiKey.includes('Rate')) return `${v.toFixed(1)}%`;
                if (kpiKey.includes('Absences')) return v.toFixed(1);
                return v;
            };

            const { grade, sped, activity } = globalFilters;
            let comparisons = [];

            // Use the same data source logic as updateDashboard
            const baseData = (USER_ROLE === 'COUNSELOR' && globalFilters.counselorGroup === 'all')
                ? allStudentsAnonymized
                : allStudentData;

            const currentData = baseData.filter(s => 
                (grade === 'all' || s.grade == grade) &&
                (sped === 'all' || (sped === 'sped' ? s.caseManager : (sped === 'gened' ? !s.caseManager : (sped === 'tier2' ? (s.tier2Interventions && s.tier2Interventions.trim() !== '') : true)))) &&
                (activity === 'all' || (s.activity || '').split(',').map(a => a.trim()).includes(activity))
            );
            const currentKpi = calculateGroupKPIs(currentData)[kpiKey];
            
            if (grade !== 'all' && (sped !== 'all' || activity !== 'all')) {
                const gradeAllSubgroupsData = baseData.filter(s => s.grade == grade);
                comparisons.push({ label: `Grade ${grade} (All Students)`, value: calculateGroupKPIs(gradeAllSubgroupsData)[kpiKey] });
            }
            if (sped !== 'all' && (grade !== 'all' || activity !== 'all')) {
                 const spedLabel = sped === 'sped' ? 'SPED' : (sped === 'gened' ? 'GenEd' : 'Tier 2');
                 const spedAllSubgroupsData = baseData.filter(s => (sped === 'sped' ? s.caseManager : (sped === 'gened' ? !s.caseManager : (sped === 'tier2' ? (s.tier2Interventions && s.tier2Interventions.trim() !== '') : true))));
                 comparisons.push({ label: `${spedLabel} (All Grades)`, value: calculateGroupKPIs(spedAllSubgroupsData)[kpiKey] });
            }
             if (activity !== 'all' && (grade !== 'all' || sped !== 'all')) {
                const activityAllSubgroupsData = baseData.filter(s => (s.activity || '').split(',').map(a => a.trim()).includes(activity));
                comparisons.push({ label: `${activity} (All Groups)`, value: calculateGroupKPIs(activityAllSubgroupsData)[kpiKey] });
            }

            let tooltipHtml = `<h4>Comparison Breakdowns</h4><ul><li><span>Current Filter:</span> <strong>${formatter(currentKpi)}</strong></li>`;
            
            const uniqueComparisons = _.uniqBy(comparisons, 'label').filter(c => Math.abs(c.value - currentKpi) > 0.01 || (c.value === 0 && currentKpi !== 0));
            
            uniqueComparisons.forEach(comp => {
                tooltipHtml += `<li><span>${comp.label}:</span> <strong>${formatter(comp.value)}</strong></li>`;
            });

            if(Math.abs(baselineKPIs[kpiKey] - currentKpi) > 0.01 || (baselineKPIs[kpiKey] === 0 && currentKpi !== 0)) {
              tooltipHtml += `<li><span>School-Wide:</span> <strong>${formatter(baselineKPIs[kpiKey])}</strong></li>`;
            }

            if (baselineKPIs[kpiKey] > 0 && kpiKey !== 'ineligibilityRate' && kpiKey !== 'avgAbsences') {
                const percentageOfTotal = (currentKpi / baselineKPIs[kpiKey]) * 100;
                tooltipHtml += `<li><span>% of Total:</span> <strong>${percentageOfTotal.toFixed(1)}%</strong></li>`;
            }
            
            tooltipHtml += `</ul>`;
            return tooltipHtml;
        }

        function renderCharts(data) {
            const chartColors = { blue: 'rgba(59, 130, 246, 0.7)', red: 'rgba(239, 68, 68, 0.7)', yellow: 'rgba(234, 179, 8, 0.7)', green: 'rgba(34, 197, 94, 0.7)', purple: 'rgba(139, 92, 246, 0.7)', orange: 'rgba(249, 115, 22, 0.7)', gray: 'rgba(107, 114, 128, 0.7)' };
            Object.values(charts).forEach(chart => chart.destroy());

            const totalUnexcused = data.reduce((sum, s) => sum + s.unexcusedAbsences, 0), totalTruancy = data.reduce((sum, s) => sum + s.truancyAbsences, 0), totalMedical = data.reduce((sum, s) => sum + s.medicalAbsences, 0), totalIllness = data.reduce((sum, s) => sum + s.illnessAbsences, 0);
            charts.attendance = new Chart(document.getElementById('attendance-breakdown-chart'), { type: 'doughnut', data: { labels: ['Unexcused', 'Truancy', 'Medical', 'Illness'], datasets: [{ data: [totalUnexcused, totalTruancy, totalMedical, totalIllness], backgroundColor: [chartColors.yellow, chartColors.red, chartColors.blue, chartColors.green] }] }, options: { maintainAspectRatio: false, responsive: true } });

            const failingOnly = data.filter(s => s.ineligible && s.isFailing && s.unservedDetention === 0).length, detentionOnly = data.filter(s => s.ineligible && !s.isFailing && s.unservedDetention > 0).length, both = data.filter(s => s.ineligible && s.isFailing && s.unservedDetention > 0).length;
            charts.ineligibility = new Chart(document.getElementById('ineligibility-chart'), { type: 'doughnut', data: { labels: ['Failing Only', 'Detention Only', 'Both'], datasets: [{ data: [failingOnly, detentionOnly, both], backgroundColor: [chartColors.red, chartColors.orange, chartColors.purple] }] }, options: { maintainAspectRatio: false, responsive: true } });

            const fGradeGroups = _.groupBy(data, 'numFGrades');
            const correlationLabels = Object.keys(fGradeGroups).sort((a,b) => a-b);
            const correlationData = correlationLabels.map(fCount => _.meanBy(fGradeGroups[fCount], 'totalAbsences') || 0);
            charts.correlation = new Chart(document.getElementById('correlation-chart'), { type: 'bar', data: { labels: correlationLabels.map(l => `${l} F's`), datasets: [{ label: 'Average Absences', data: correlationData, backgroundColor: chartColors.blue }] }, options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Average Absences (Periods)' } }, x: { title: { display: true, text: 'Number of Failing Grades' } } } } });
            
            const activityStudents = data.filter(s => s.activity), nonActivityStudents = data.filter(s => !s.activity);
            charts.activity = new Chart(document.getElementById('activity-chart'), { type: 'bar', data: { labels: ['Ineligibility Rate (%)', 'Avg Absences (Periods)'], datasets: [{ label: `In Activity (${activityStudents.length})`, data: [calculateGroupKPIs(activityStudents).ineligibilityRate, calculateGroupKPIs(activityStudents).avgAbsences], backgroundColor: chartColors.blue }, { label: `Not in Activity (${nonActivityStudents.length})`, data: [calculateGroupKPIs(nonActivityStudents).ineligibilityRate, calculateGroupKPIs(nonActivityStudents).avgAbsences], backgroundColor: chartColors.gray }] }, options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true } } } });

            // New Spartan Hour Chart
            const spartanHourLabels = ['Total Requests', 'Skipped Requests', 'High Priority Requests'];
            const spartanHourData = [
                data.reduce((sum, s) => sum + s.spartanHourTotalRequests, 0),
                data.reduce((sum, s) => sum + s.spartanHourSkippedRequests, 0),
                data.reduce((sum, s) => sum + s.spartanHourReqsHighPriority, 0)
            ];
            charts.spartanHour = new Chart(document.getElementById('spartan-hour-chart'), {
                type: 'bar',
                data: {
                    labels: spartanHourLabels,
                    datasets: [{
                        label: 'Number of Requests',
                        data: spartanHourData,
                        backgroundColor: [chartColors.blue, chartColors.red, chartColors.yellow]
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Requests' } },
                        x: { title: { display: true, text: 'Spartan Hour Metrics' } }
                    }
                }
            });

            // New Club Participation by Grade Chart
            const gradesForClubParticipation = [...new Set(data.map(s => s.grade))].filter(g => g > 0).sort((a, b) => a - b);
            const clubParticipationByGrade = gradesForClubParticipation.map(grade => {
                const studentsInGrade = data.filter(s => s.grade === grade);
                return studentsInGrade.filter(s => s.totalClubMeetingsAttended > 0 || (s.clubsAttended && s.clubsAttended.trim() !== '')).length;
            });
            charts.clubMeetingsByGrade = new Chart(document.getElementById('club-meetings-by-grade-chart'), {
                type: 'bar',
                data: {
                    labels: gradesForClubParticipation.map(g => `Grade ${g}`),
                    datasets: [{
                        label: 'Number of Students Participating',
                        data: clubParticipationByGrade,
                        backgroundColor: chartColors.green
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Students' } },
                        x: { title: { display: true, text: 'Grade Level' } }
                    }
                }
            });
        }

        // Render KPIs from pre-computed aggregated data (for counselor "All Students" view)
        function renderKPIsFromAggregated(kpis) {
            document.getElementById('total-students').textContent = kpis.totalStudents;
            document.getElementById('ineligible-students').textContent = kpis.ineligibleStudents;
            document.getElementById('ineligibility-rate').textContent = `${kpis.ineligibilityRate.toFixed(1)}%`;
            document.getElementById('avg-absences').textContent = kpis.avgAbsences.toFixed(1);
            document.getElementById('total-f-grades').textContent = kpis.totalFGrades;
            document.getElementById('spartan-total-requests').textContent = kpis.spartanHourTotalRequests;
            document.getElementById('spartan-skipped-requests').textContent = kpis.spartanHourSkippedRequests;
            document.getElementById('spartan-high-priority-requests').textContent = kpis.spartanHourReqsHighPriority;
            document.getElementById('df-no-request').textContent = kpis.dfNoRequestCount || 0;
            if (kpis.dfNoRequestDate) {
                document.getElementById('df-no-request-label').textContent = `D/F List No Request (${kpis.dfNoRequestDate})`;
            }
            document.getElementById('total-students-with-club-meetings').textContent = kpis.totalStudentsWithClubMeetings;
        }

        // Render charts from pre-computed aggregated data (for counselor "All Students" view)
        function renderChartsFromAggregated(chartData) {
            const chartColors = { blue: 'rgba(59, 130, 246, 0.7)', red: 'rgba(239, 68, 68, 0.7)', yellow: 'rgba(234, 179, 8, 0.7)', green: 'rgba(34, 197, 94, 0.7)', purple: 'rgba(139, 92, 246, 0.7)', orange: 'rgba(249, 115, 22, 0.7)', gray: 'rgba(107, 114, 128, 0.7)' };
            Object.values(charts).forEach(chart => chart.destroy());

            // Attendance breakdown
            const ab = chartData.absenceBreakdown;
            charts.attendance = new Chart(document.getElementById('attendance-breakdown-chart'), { type: 'doughnut', data: { labels: ['Unexcused', 'Truancy', 'Medical', 'Illness'], datasets: [{ data: [ab.unexcused, ab.truancy, ab.medical, ab.illness], backgroundColor: [chartColors.yellow, chartColors.red, chartColors.blue, chartColors.green] }] }, options: { maintainAspectRatio: false, responsive: true } });

            // Ineligibility reasons
            const ir = chartData.ineligibilityReasons;
            const failingOnly = ir.failing - ir.both;
            const detentionOnly = ir.detention - ir.both;
            charts.ineligibility = new Chart(document.getElementById('ineligibility-chart'), { type: 'doughnut', data: { labels: ['Failing Only', 'Detention Only', 'Both'], datasets: [{ data: [failingOnly, detentionOnly, ir.both], backgroundColor: [chartColors.red, chartColors.orange, chartColors.purple] }] }, options: { maintainAspectRatio: false, responsive: true } });

            // Correlation chart
            const correlationLabels = Object.keys(chartData.correlationData).sort((a, b) => a - b);
            const correlationValues = correlationLabels.map(fCount => {
                const absences = chartData.correlationData[fCount];
                return absences.length ? absences.reduce((a, b) => a + b, 0) / absences.length : 0;
            });
            charts.correlation = new Chart(document.getElementById('correlation-chart'), { type: 'bar', data: { labels: correlationLabels.map(l => `${l} F's`), datasets: [{ label: 'Average Absences', data: correlationValues, backgroundColor: chartColors.blue }] }, options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Average Absences (Periods)' } }, x: { title: { display: true, text: 'Number of Failing Grades' } } } } });

            // Activity comparison
            const ac = chartData.activityComparison;
            charts.activity = new Chart(document.getElementById('activity-chart'), { type: 'bar', data: { labels: ['Ineligibility Rate (%)', 'Avg Absences (Periods)'], datasets: [{ label: `In Activity (${ac.withActivity.count})`, data: [ac.withActivity.ineligibleRate, ac.withActivity.avgAbsences], backgroundColor: chartColors.blue }, { label: `Not in Activity (${ac.withoutActivity.count})`, data: [ac.withoutActivity.ineligibleRate, ac.withoutActivity.avgAbsences], backgroundColor: chartColors.gray }] }, options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true } } } });

            // Spartan Hour chart
            const sh = chartData.spartanHour;
            charts.spartanHour = new Chart(document.getElementById('spartan-hour-chart'), { type: 'bar', data: { labels: ['Total Requests', 'Skipped Requests', 'High Priority Requests'], datasets: [{ label: 'Number of Requests', data: [sh.total, sh.skipped, sh.highPriority], backgroundColor: [chartColors.blue, chartColors.red, chartColors.yellow] }] }, options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Requests' } }, x: { title: { display: true, text: 'Spartan Hour Metrics' } } } } });

            // Club participation by grade
            const grades = [9, 10, 11, 12];
            const clubData = grades.map(g => chartData.byGrade[g].filter(s => s.totalClubMeetingsAttended > 0).length);
            charts.clubMeetingsByGrade = new Chart(document.getElementById('club-meetings-by-grade-chart'), { type: 'bar', data: { labels: grades.map(g => `Grade ${g}`), datasets: [{ label: 'Number of Students Participating', data: clubData, backgroundColor: chartColors.green }] }, options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Students' } }, x: { title: { display: true, text: 'Grade Level' } } } } });
        }

        function setupStudentListFilters() {
            document.getElementById('student-search').addEventListener('keyup', e => { studentListFilters.search = e.target.value.toLowerCase(); applyStudentListFilters(); });
            document.getElementById('student-activity-filter').addEventListener('change', e => { studentListFilters.activity = e.target.value; applyStudentListFilters(); });
            const gradeFilterContainer = document.getElementById('student-grade-filters');
            gradeFilterContainer.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { gradeFilterContainer.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); studentListFilters.grade = e.target.dataset.grade; applyStudentListFilters(); } });
            const eligibilityContainer = document.getElementById('student-eligibility-filters');
            eligibilityContainer.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { eligibilityContainer.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); studentListFilters.eligibility = e.target.dataset.status; applyStudentListFilters(); } });
        }
        
        function setupSorting() {
            document.querySelectorAll('thead th[data-sort]').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    if (studentListSort.key === sortKey) {
                        studentListSort.order = studentListSort.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        studentListSort.key = sortKey;
                        studentListSort.order = ['numFGrades', 'unservedDetention', 'totalAbsences', 'grade'].includes(sortKey) ? 'desc' : 'asc';
                    }
                    updateSortIcons();
                    applyStudentListFilters();
                });
            });
        }

        function updateSortIcons() {
            document.querySelectorAll('thead .sort-icon').forEach(icon => icon.textContent = '');
            const activeHeaderIcon = document.querySelector(`thead th[data-sort="${studentListSort.key}"] .sort-icon`);
            if (activeHeaderIcon) activeHeaderIcon.textContent = studentListSort.order === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        }

        function applyStudentListFilters() {
            // For counselors, allStudentData is already filtered by backend to their alpha range
            let data = [...allStudentData];

            if (studentListFilters.grade !== 'all') data = data.filter(s => s.grade == studentListFilters.grade);
            if (studentListFilters.activity !== 'all') data = data.filter(s => (s.activity || '').split(',').map(a => a.trim()).includes(studentListFilters.activity));
            if (studentListFilters.search) data = data.filter(s => s.studentName.toLowerCase().includes(studentListFilters.search));
            if (studentListFilters.eligibility === 'eligible') data = data.filter(s => !s.ineligible);
            if (studentListFilters.eligibility === 'ineligible') data = data.filter(s => s.ineligible);

            const { key, order } = studentListSort;
            data.sort((a, b) => {
                let valA = a[key], valB = b[key];
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = b[key].toLowerCase(); }
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
            renderStudentList(data);
        }

        function renderStudentList(data) {
            const listBody = document.getElementById('student-list'), noResults = document.getElementById('no-students-message');
            if (data.length === 0) { listBody.innerHTML = ''; noResults.classList.remove('hidden'); return; }
            noResults.classList.add('hidden');
            listBody.innerHTML = data.map(s => `<tr class="${s.ineligible ? 'bg-red-50' : 'bg-white'}">
                <td class="px-6 py-4 text-sm text-gray-500 text-center">${s.grade}</td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${s.studentName}</div><div class="text-sm text-gray-500">ID: ${s.id}</div>${s.caseManager ? `<div class="text-xs font-semibold text-blue-600 cursor-pointer tooltip-trigger mt-1" data-student='${JSON.stringify(s)}' data-type="caseManager">Sp.Ed.</div>` : ''}${s.tier2Interventions || s.tier2Instructor ? `<div class="text-xs font-semibold text-purple-600 cursor-pointer tooltip-trigger mt-1" data-student='${JSON.stringify(s)}' data-type="tier2">Tier 2</div>` : ''}</td>
                <td class="px-6 py-4 text-xs text-gray-500">${s.activity || ''}</td>
                <td class="px-6 py-4 text-sm text-gray-500 text-center tooltip-trigger ${s.numFGrades > 0 ? 'border-2 border-red-700' : ''}" data-student='${JSON.stringify(s)}' data-type="failing">${s.numFGrades}</td>
                <td class="px-6 py-4 text-sm text-gray-500 text-center tooltip-trigger ${s.unservedDetention > 0 ? 'border-2 border-red-700' : ''}" data-student='${JSON.stringify(s)}' data-type="detention">${s.unservedDetention} hrs</td>
                <td class="px-6 py-4 text-sm text-gray-500 text-center tooltip-trigger" data-student='${JSON.stringify(s)}' data-type="absences">${s.totalAbsences}</td>
                <td class="px-6 py-4 text-sm text-gray-500 text-center tooltip-trigger" data-student='${JSON.stringify(s)}' data-type="spartanHour">${s.spartanHourTotalRequests} request${s.spartanHourTotalRequests === 1 ? '' : 's'}</td>
            </tr>`).join('');
        }
        
        function setupTooltips() {
            document.body.addEventListener('click', e => {
                const kpiCard = e.target.closest('.kpi-card.clickable');
                const studentCell = e.target.closest('.tooltip-trigger');

                if (kpiCard) {
                    e.stopPropagation();
                    const triggerId = kpiCard.id;
                    if (tooltip.style.display === 'block' && tooltip.dataset.triggerId === triggerId) {
                        hideTooltip(); return;
                    }
                    const key = kpiCard.dataset.tooltipKey;
                    
                    if (key === 'dfNoRequestCount') {
                        const { grade, sped, activity } = globalFilters;
                        const baseData = (USER_ROLE === 'COUNSELOR' && globalFilters.counselorGroup === 'all') ? allStudentsAnonymized : allStudentData;
                        const currentData = baseData.filter(s => (grade === 'all' || s.grade == grade) && (sped === 'all' || (sped === 'sped' ? s.caseManager : (sped === 'gened' ? !s.caseManager : (sped === 'tier2' ? (s.tier2Interventions && s.tier2Interventions.trim() !== '') : true)))) && (activity === 'all' || (s.activity || '').split(',').map(a => a.trim()).includes(activity)));
                        const noReq = currentData.filter(s => s.isOnDFNoRequestList);
                        const withF = noReq.filter(s => s.numFGrades > 0).length;
                        const withD = noReq.length - withF;
                        showTooltip(`<h4>D/F No Request Breakdown</h4><ul><li><span>Total:</span> <strong>${noReq.length}</strong></li><li><span>With Fs:</span> <strong class="text-red-500">${withF}</strong></li><li><span>With Ds:</span> <strong class="text-yellow-500">${withD}</strong></li></ul>`, kpiCard, triggerId);
                        return;
                    }

                    const html = generateComparisonTooltip(key);
                    showTooltip(html, kpiCard, triggerId);
                } else if (studentCell) {
                    e.stopPropagation();
                    const triggerId = `${studentCell.parentElement.rowIndex}-${studentCell.cellIndex}`;
                    if (tooltip.style.display === 'block' && tooltip.dataset.triggerId === triggerId) {
                        hideTooltip(); return;
                    }
                    const student = JSON.parse(studentCell.dataset.student);
                    const type = studentCell.dataset.type;
                    let content = '';
                    if (type === 'failing' && student.numFGrades > 0) {
                        const classes = student.failingClasses.split('\n').filter(Boolean).map(c => `<li>${c}</li>`).join('');
                        let weeksHTML = '';
                        if (student.consecutiveWeeks > 0) {
                            weeksHTML = `<div style="margin-top: 10px;"><h4>Consecutive Weeks on D/F List</h4><p>${student.consecutiveWeeks}</p></div>`;
                        }
                        content = `<h4>Failing Classes</h4><ul style="list-style: inside;">${classes}</ul>${weeksHTML}`;
                    } else if (type === 'detention' && student.unservedDetention > 0) {
                        content = `<h4>Detention Details</h4><ul><li><span>Discipline:</span> <strong>${student.disciplineDetention} hrs</strong></li><li><span>Attendance:</span> <strong>${student.attendanceDetention} hrs</strong></li></ul>`;
                    } else if (type === 'absences') {
                        if (student.totalAbsences > 0) {
                            content = `<h4>Absence Details</h4><ul><li><span>Unexcused:</span> <strong>${student.unexcusedAbsences}</strong></li><li><span>Truancy:</span> <strong>${student.truancyAbsences}</strong></li><li><span>Medical:</span> <strong>${student.medicalAbsences}</strong></li><li><span>Illness:</span> <strong>${student.illnessAbsences}</strong></li></ul>`;
                        }
                        if (student.attendanceLetters) {
                            content += `<div style="margin-top: 10px;"><h4>Attendance Letters</h4><p>${student.attendanceLetters}</p></div>`;
                        }
                    } else if (type === 'spartanHour') {
                        content = `<h4>Spartan Hour Details</h4><ul><li><span>Total Requests:</span> <strong>${student.spartanHourTotalRequests}</strong></li><li><span>Most Recent:</span> <strong>${student.mostRecentSpartanHourRequest || 'N/A'}</strong></li><li><span>Skipped Requests:</span> <strong>${student.spartanHourSkippedRequests}</strong></li><li><span>High Priority:</span> <strong>${student.spartanHourReqsHighPriority}</strong></li></ul>`;
                        if (student.totalClubMeetingsAttended > 0 || (student.clubsAttended && student.clubsAttended.trim() !== '')) {
                            content += `<div style="margin-top: 10px;"><h4>Club Details</h4><ul><li><span>Meetings Attended:</span> <strong>${student.totalClubMeetingsAttended}</strong></li><li><span>Clubs:</span> <strong>${student.clubsAttended || 'N/A'}</strong></li></ul></div>`;
                        }
                    } else if (type === 'caseManager' && student.caseManager) {
                        content = `<h4>Case Manager</h4><p>${student.caseManager}</p>`;
                    } else if (type === 'tier2') {
                        let tier2Content = '<h4>Tier 2 Details</h4><ul>';
                        if (student.tier2Instructor) {
                            tier2Content += `<li><span>Instructor:</span> <strong>${student.tier2Instructor}</strong></li>`;
                        }
                        if (student.tier2Interventions) {
                            tier2Content += `<li><span>Intervention:</span> <strong>${student.tier2Interventions}</strong></li>`;
                        }
                        tier2Content += '</ul>';
                        content = tier2Content;
                    }
                    if(content) showTooltip(content, studentCell, triggerId);
                } else if (tooltip.style.display === 'block') {
                    hideTooltip();
                }
            });
        }

        function showTooltip(html, element, triggerId) {
            tooltip.innerHTML = html;
            tooltip.style.display = 'block';
            tooltip.dataset.triggerId = triggerId;
            const rect = element.getBoundingClientRect();
            let top = rect.bottom + window.scrollY + 5;
            let left = rect.left + window.scrollX;
            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
            const tooltipRect = tooltip.getBoundingClientRect();
            if (tooltipRect.right > window.innerWidth) tooltip.style.left = `${window.innerWidth - tooltipRect.width - 20}px`;
            if (tooltipRect.bottom > (window.innerHeight - 20) ) tooltip.style.top = `${rect.top + window.scrollY - tooltipRect.height - 5}px`;
            setTimeout(() => { tooltip.style.opacity = 1; }, 10);
        }

        function hideTooltip() {
            tooltip.style.opacity = 0;
            setTimeout(() => { 
                tooltip.style.display = 'none'; 
                tooltip.removeAttribute('data-trigger-id');
            }, 200);
        }

        function setupClearButtons() {
            document.getElementById('reset-global-filters-btn').addEventListener('click', () => {
                document.getElementById('grade-filter').value = 'all';
                document.getElementById('sped-filter').value = 'all';
                document.getElementById('activity-filter').value = 'all';
                if (USER_ROLE === 'COUNSELOR') {
                    document.getElementById('counselor-group-filter').value = 'my';
                }
                globalFilters = { grade: 'all', sped: 'all', activity: 'all', counselorGroup: 'my' };
                updateDashboard();
            });

            document.getElementById('reset-student-filters-btn').addEventListener('click', () => {
                document.getElementById('student-search').value = '';
                document.getElementById('student-activity-filter').value = 'all';

                document.querySelector('#student-grade-filters .filter-btn.active').classList.remove('active');
                document.querySelector('#student-grade-filters .filter-btn[data-grade="all"]').classList.add('active');

                document.querySelector('#student-eligibility-filters .filter-btn.active').classList.remove('active');
                document.querySelector('#student-eligibility-filters .filter-btn[data-status="all"]').classList.add('active');

                studentListFilters = { search: '', grade: 'all', eligibility: 'all', activity: 'all' };
                applyStudentListFilters();
            });
        }

        // ===============================================================
        // HISTORICAL TRENDS FUNCTIONALITY
        // ===============================================================

        function loadHistoricalData() {
            document.getElementById('snapshot-info').innerHTML = '<p class="text-gray-500">Loading historical data...</p>';

            google.script.run
                .withSuccessHandler(response => {
                    if (!response || typeof response.trends === 'undefined' || typeof response.snapshotList === 'undefined') {
                        console.error('Received invalid response from getHistoricalDataForClient:', response);
                        document.getElementById('snapshot-info').innerHTML = '<p class="text-red-500">Error: Invalid historical data received from server.</p>';
                        return;
                    }
                    historicalData = response.trends;
                    const snapshotList = response.snapshotList;
                    displayHistoricalInfo();
                    populateSnapshotSelectors(snapshotList);
                    if (historicalData && historicalData.length > 0) {
                        renderHistoricalCharts();
                    }
                })
                .withFailureHandler(error => {
                    console.error('Error loading historical data:', error);
                    document.getElementById('snapshot-info').innerHTML = '<p class="text-red-500">Error loading historical data. Please try again.</p>';
                })
                .getHistoricalDataForClient();
        }

        function displayHistoricalInfo() {
            const infoDiv = document.getElementById('snapshot-info');
            if (!historicalData || historicalData.length === 0) {
                infoDiv.innerHTML = '<p class="text-yellow-600 font-medium">No historical snapshots found. Click "Create Snapshot Now" to capture the current data.</p>';
            } else {
                const latestSnapshot = historicalData[historicalData.length - 1];
                infoDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Total Snapshots</p>
                            <p class="text-2xl font-bold text-blue-700">${historicalData.length}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Latest Snapshot</p>
                            <p class="text-lg font-semibold text-green-700">${latestSnapshot.formattedDate}</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Students Tracked</p>
                            <p class="text-2xl font-bold text-purple-700">${latestSnapshot.totalStudents}</p>
                        </div>
                    </div>
                `;
            }
        }

        function populateSnapshotSelectors(snapshots) {
            const selector1 = document.getElementById('comparison-date-1');
            const selector2 = document.getElementById('comparison-date-2');

            selector1.innerHTML = '<option value="">Select a snapshot date...</option>';
            selector2.innerHTML = '<option value="">Select a snapshot date...</option>';

            snapshots.forEach(snapshot => {
                selector1.innerHTML += `<option value="${snapshot.timestamp}">${snapshot.formattedDate}</option>`;
                selector2.innerHTML += `<option value="${snapshot.timestamp}">${snapshot.formattedDate}</option>`;
            });
        }

        function renderHistoricalCharts() {
            if (!historicalData || historicalData.length === 0) return;

            document.getElementById('historical-charts-container').classList.remove('hidden');
            const chartColors = { blue: 'rgba(59, 130, 246, 0.7)', red: 'rgba(239, 68, 68, 0.7)', yellow: 'rgba(234, 179, 8, 0.7)', green: 'rgba(34, 197, 94, 0.7)' };

            const labels = historicalData.map(d => d.formattedDate);

            // Failing Grades Chart
            const failingData = {
                labels: labels,
                datasets: [
                    {
                        label: '2+ F Grades (Ineligible)',
                        data: historicalData.map(d => d.studentsWith2PlusF),
                        backgroundColor: chartColors.red,
                        borderColor: chartColors.red,
                        borderWidth: 2
                    },
                    {
                        label: '1 F Grade (At Risk)',
                        data: historicalData.map(d => d.studentsWith1F),
                        backgroundColor: chartColors.yellow,
                        borderColor: chartColors.yellow,
                        borderWidth: 2
                    }
                ]
            };

            if (charts.historicalFailing) charts.historicalFailing.destroy();
            charts.historicalFailing = new Chart(document.getElementById('historical-failing-chart'), {
                type: 'line',
                data: failingData,
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Students' } },
                        x: { title: { display: true, text: 'Snapshot Date' } }
                    }
                }
            });

            // Average Absences Chart
            if (charts.historicalAbsences) charts.historicalAbsences.destroy();
            charts.historicalAbsences = new Chart(document.getElementById('historical-absences-chart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Absences',
                        data: historicalData.map(d => typeof d.avgAbsences === 'number' ? d.avgAbsences : 0),
                        backgroundColor: chartColors.blue,
                        borderColor: chartColors.blue,
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Average Absences (Periods)' } },
                        x: { title: { display: true, text: 'Snapshot Date' } }
                    }
                }
            });

            // Detention Chart
            if (charts.historicalDetention) charts.historicalDetention.destroy();
            charts.historicalDetention = new Chart(document.getElementById('historical-detention-chart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Unserved Detention',
                        data: historicalData.map(d => typeof d.avgUnservedDetention === 'number' ? d.avgUnservedDetention : 0),
                        backgroundColor: chartColors.yellow
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Average Hours' } },
                        x: { title: { display: true, text: 'Snapshot Date' } }
                    }
                }
            });

            // Ineligibility Rate Chart - uses pre-calculated backend value
            if (charts.historicalIneligibility) charts.historicalIneligibility.destroy();
            charts.historicalIneligibility = new Chart(document.getElementById('historical-ineligibility-chart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ineligibility Rate',
                        data: historicalData.map(d => typeof d.ineligibilityRate === 'number' ? d.ineligibilityRate : 0),
                        backgroundColor: chartColors.red,
                        borderColor: chartColors.red,
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Percentage (%)' } },
                        x: { title: { display: true, text: 'Snapshot Date' } }
                    }
                }
            });
        }

        // Constants for maintainability
        const SUCCESS_MESSAGE_TIMEOUT = 5000; // Auto-hide timeout for success messages
        const CONCERNING_METRICS = ['Ineligible', 'Failing', 'Detention', 'Absences', 'Skipped', 'Truancy'];

        // Helper function to show inline messages instead of alerts
        function showMessage(elementId, message, type = 'info') {
            const messageDiv = document.getElementById(elementId);
            messageDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-blue-100', 'text-green-800', 'text-red-800', 'text-blue-800');

            if (type === 'success') {
                messageDiv.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageDiv.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageDiv.classList.add('bg-blue-100', 'text-blue-800');
            }

            messageDiv.textContent = message;

            // Auto-hide success messages after configured timeout
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, SUCCESS_MESSAGE_TIMEOUT);
            }
        }

        // Helper function to determine if a metric change is concerning
        function isMetricConcerning(metricName) {
            return CONCERNING_METRICS.some(keyword => metricName.includes(keyword));
        }

        // Helper function to get change indicators
        function getMetricChangeIndicator(metricName, delta) {
            const isConcerning = isMetricConcerning(metricName);
            let rowColor, deltaColor, arrow, textIndicator;

            if (delta > 0) {
                if (isConcerning) {
                    rowColor = 'bg-red-50';
                    deltaColor = 'text-red-700 font-semibold';
                    arrow = '‚Üë';
                    textIndicator = '<span class="text-xs font-bold">[WORSE]</span> ';
                } else {
                    rowColor = 'bg-green-50';
                    deltaColor = 'text-green-700 font-semibold';
                    arrow = '‚Üë';
                    textIndicator = '<span class="text-xs font-bold">[BETTER]</span> ';
                }
            } else if (delta < 0) {
                if (isConcerning) {
                    rowColor = 'bg-green-50';
                    deltaColor = 'text-green-700 font-semibold';
                    arrow = '‚Üì';
                    textIndicator = '<span class="text-xs font-bold">[BETTER]</span> ';
                } else {
                    rowColor = 'bg-red-50';
                    deltaColor = 'text-red-700 font-semibold';
                    arrow = '‚Üì';
                    textIndicator = '<span class="text-xs font-bold">[WORSE]</span> ';
                }
            } else {
                rowColor = 'bg-white';
                deltaColor = 'text-gray-600';
                arrow = '';
                textIndicator = '';
            }

            return { rowColor, deltaColor, arrow, textIndicator };
        }

        // Helper function to format error messages
        function formatErrorMessage(error) {
            return error && error.message ? error.message : String(error);
        }

        // Setup event listeners for historical tab
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('create-snapshot-btn').addEventListener('click', () => {
                const btn = document.getElementById('create-snapshot-btn');
                btn.disabled = true;
                btn.setAttribute('aria-busy', 'true');
                btn.setAttribute('aria-disabled', 'true');
                btn.textContent = 'Creating...';

                google.script.run
                    .withSuccessHandler(() => {
                        btn.disabled = false;
                        btn.removeAttribute('aria-busy');
                        btn.removeAttribute('aria-disabled');
                        btn.textContent = 'Create Snapshot Now';
                        historicalData = null;
                        loadHistoricalData();
                        showMessage('snapshot-message', 'Snapshot created successfully!', 'success');
                    })
                    .withFailureHandler(error => {
                        btn.disabled = false;
                        btn.removeAttribute('aria-busy');
                        btn.removeAttribute('aria-disabled');
                        btn.textContent = 'Create Snapshot Now';
                        showMessage('snapshot-message', 'Error creating snapshot: ' + formatErrorMessage(error), 'error');
                    })
                    .createWeeklySnapshot();
            });

            document.getElementById('compare-snapshots-btn').addEventListener('click', () => {
                const date1 = document.getElementById('comparison-date-1').value;
                const date2 = document.getElementById('comparison-date-2').value;

                // Clear previous messages
                document.getElementById('comparison-message').classList.add('hidden');

                if (!date1 || !date2) {
                    showMessage('comparison-message', 'Please select two snapshot dates to compare.', 'error');
                    return;
                }

                if (date1 === date2) {
                    showMessage('comparison-message', 'Please select two different snapshot dates.', 'error');
                    return;
                }

                document.getElementById('comparison-results').innerHTML = '<p class="text-gray-500">Comparing snapshots...</p>';

                google.script.run
                    .withSuccessHandler(comparison => {
                        displayComparisonResults(comparison);
                    })
                    .withFailureHandler(error => {
                        document.getElementById('comparison-results').innerHTML = '<p class="text-red-500">Error comparing snapshots: ' + formatErrorMessage(error) + '</p>';
                    })
                    .compareSnapshots(new Date(parseInt(date1)), new Date(parseInt(date2)));
            });
        });

        function displayComparisonResults(comparison) {
            if (!comparison) {
                document.getElementById('comparison-results').innerHTML = `<p class="text-red-500">No data available for comparison.</p>`;
                return;
            }
            if (comparison.error) {
                document.getElementById('comparison-results').innerHTML = `<p class="text-red-500">${comparison.error}</p>`;
                return;
            }

            const changedCount = comparison.changes ? comparison.changes.length : 0;
            let html = `
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <h3 class="text-lg font-semibold mb-2">Global Metrics Comparison</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><strong>From:</strong> ${comparison.date1}</div>
                        <div><strong>To:</strong> ${comparison.date2}</div>
                        <div class="col-span-2"><strong>Metrics that Changed:</strong> ${changedCount}</div>
                    </div>
                </div>
            `;

            if (changedCount > 0) {
                html += '<div class="mt-4"><h4 class="font-semibold mb-2">Changes in Global Metrics:</h4><div class="max-h-96 overflow-y-auto"><table class="w-full border-collapse border border-gray-300"><thead class="bg-gray-100"><tr><th class="border border-gray-300 px-4 py-2 text-left">Metric</th><th class="border border-gray-300 px-4 py-2 text-center">Week 1</th><th class="border border-gray-300 px-4 py-2 text-center">Week 2</th><th class="border border-gray-300 px-4 py-2 text-center">Change</th><th class="border border-gray-300 px-4 py-2 text-center">% Change</th></tr></thead><tbody>';

                comparison.changes.forEach(change => {
                    const delta = parseFloat(change.delta);
                    // Handle 'N/A' for percent change when baseline is zero
                    const percentChange = change.percentChange === 'N/A' ? 'N/A' : parseFloat(change.percentChange);

                    // Use helper function to determine styling
                    const { rowColor, deltaColor, arrow, textIndicator } = getMetricChangeIndicator(change.metric, delta);

                    // Format percent change display
                    const percentDisplay = percentChange === 'N/A'
                        ? 'N/A'
                        : `${percentChange > 0 ? '+' : ''}${percentChange}%`;

                    // Improved aria-label for screen readers
                    const ariaLabel = delta === 0
                        ? 'No change'
                        : `Change: ${delta > 0 ? 'Increased' : 'Decreased'} by ${Math.abs(delta)}`;

                    html += `<tr class="${rowColor}">
                        <td class="border border-gray-300 px-4 py-2">${textIndicator}${change.metric}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${change.oldValue}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${change.newValue}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center ${deltaColor}" aria-label="${ariaLabel}">${arrow} ${delta > 0 ? '+' : ''}${change.delta}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center ${deltaColor}">${percentDisplay}</td>
                    </tr>`;
                });

                html += '</tbody></table></div></div>';
            } else {
                html += '<p class="text-gray-600 mt-4">No significant changes detected between these snapshots.</p>';
            }

            // Add full metrics table
            if (comparison.allMetrics && comparison.allMetrics.length > 0) {
                html += '<div class="mt-6"><h4 class="font-semibold mb-2">All Metrics (Side-by-Side):</h4><div class="max-h-96 overflow-y-auto"><table class="w-full border-collapse border border-gray-300 text-sm"><thead class="bg-gray-100"><tr><th class="border border-gray-300 px-3 py-2 text-left">Metric</th><th class="border border-gray-300 px-3 py-2 text-center">' + comparison.date1 + '</th><th class="border border-gray-300 px-3 py-2 text-center">' + comparison.date2 + '</th></tr></thead><tbody>';

                comparison.allMetrics.forEach(metric => {
                    html += `<tr class="bg-white hover:bg-gray-50">
                        <td class="border border-gray-300 px-3 py-2">${metric.metric}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center">${metric.value1}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center">${metric.value2}</td>
                    </tr>`;
                });

                html += '</tbody></table></div></div>';
            }

            document.getElementById('comparison-results').innerHTML = html;
        }

    </script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
</body>
</html>

