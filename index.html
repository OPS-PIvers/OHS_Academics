<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHS Academics & Attendance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #2d3f89; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; }
        .kpi-card { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .kpi-value { font-size: 2.5rem; font-weight: 700; color: #2d3f89; }
        .kpi-label { font-size: 1rem; font-weight: 500; color: #4b5563; }
        .ineligible-text { color: #ef4444; font-weight: 600; }
        .eligible-text { color: #22c55e; font-weight: 600; }
        .filter-btn { padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: white; color: #374151; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover { background-color: #f3f4f6; }
        .filter-btn.active { background-color: #2d3f89; color: white; border-color: #2d3f89; }
        select.filter-select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
            padding: 0.5rem 2.5rem 0.5rem 0.75rem;
            border-radius: 0.5rem; border: 1px solid #d1d5db;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        select.filter-select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); }
        .fixed-table { table-layout: fixed; width: 100%; }
        th[data-sort] { cursor: pointer; }
        .sort-icon { color: #9ca3af; font-size: 0.9em; vertical-align: middle; }
        .tooltip-trigger, .kpi-card.clickable { cursor: pointer; }
        .header-title { text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5); }
        .header-subtitle { text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.4); }
        /* Tooltip Styles */
        #tooltip {
            position: absolute; display: none;
            background-color: #111827; color: white;
            padding: 0.75rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 0.875rem; max-width: 300px;
            z-index: 1000;
            transition: opacity 0.2s;
        }
        #tooltip h4 { font-weight: 600; margin-bottom: 0.5rem; border-bottom: 1px solid #4b5563; padding-bottom: 0.5rem;}
        #tooltip ul { list-style: none; padding-left: 0; }
        #tooltip li { margin-top: 0.5rem; display: flex; justify-content: space-between; }
        #tooltip li span:first-child { color: #d1d5db; padding-right: 1rem; }
        .ineligible-row { background-color: #fee2e2; } /* Light red for ineligible students */
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div id="tooltip"></div>
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-white header-title tracking-tight">OHS Academics & Attendance Dashboard</h1>
            <p class="text-gray-300 mt-2 header-subtitle">Visual analysis of student performance and attendance.</p>
        </header>

        <div id="loading-state" class="text-center py-16 bg-white rounded-lg">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-gray-600 font-medium">Loading and processing student data...</p>
        </div>

        <main id="dashboard-content" class="hidden">
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-students" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-white border-white">Student List</button>
                    <button id="tab-visuals" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-400 border-transparent hover:text-white hover:border-gray-300">Data Visualizations</button>
                    <button id="tab-snapshots" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-400 border-transparent hover:text-white hover:border-gray-300">Weekly Snapshots</button>
                </nav>
            </div>

            <div id="tab-content-students">
                <div class="card mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Student Lookup Filters</h2>
                        <button id="reset-student-filters-btn" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition">Clear Filters</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="student-search" placeholder="Search by student name..." class="w-full p-2 border border-gray-300 rounded-lg">
                        <div>
                            <label for="student-activity-filter" class="sr-only">Filter by Activity</label>
                            <select id="student-activity-filter" class="filter-select w-full"></select>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                         <div id="student-grade-filters" class="flex flex-wrap items-center gap-2"><span class="font-medium text-gray-600">Grade:</span><button class="filter-btn active" data-grade="all">All</button><button class="filter-btn" data-grade="9">9</button><button class="filter-btn" data-grade="10">10</button><button class="filter-btn" data-grade="11">11</button><button class="filter-btn" data-grade="12">12</button></div>
                        <div id="student-eligibility-filters" class="flex flex-wrap items-center gap-2"><span class="font-medium text-gray-600">Status:</span><button class="filter-btn active" data-status="all">All</button><button class="filter-btn" data-status="ineligible">Ineligible</button><button class="filter-btn" data-status="eligible">Eligible</button></div>
                    </div>
                    <div class="overflow-x-auto"><table class="fixed-table"><thead class="bg-gray-50 sticky top-0 z-10"><tr><th class="w-1/12 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="grade">Grade <span class="sort-icon"></span></th><th class="w-2/12 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="studentName">Student Name <span class="sort-icon"></span></th><th class="w-2/12 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activities</th><th class="w-1/12 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="numFGrades">Failing <span class="sort-icon"></span></th><th class="w-1/12 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="unservedDetention">Detention <span class="sort-icon"></span></th><th class="w-1/12 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="totalAbsences">Absences <span class="sort-icon"></span></th><th class="w-2/12 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Spartan Hour</th></tr></thead><tbody id="student-list" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                    <div id="no-students-message" class="text-center py-8 text-gray-500 hidden">No students match the current filters.</div>
                </div>
            </div>

            <div id="tab-content-visuals" class="hidden">
                 <div class="card mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Global Dashboard Filters</h2>
                        <button id="reset-global-filters-btn" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition">Clear Filters</button>
                    </div>
                    <div id="global-filters" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="grade-filter" class="block text-sm font-medium text-gray-700 mb-1">Grade Level</label>
                            <select id="grade-filter" class="filter-select w-full"><option value="all">All Grades</option><option value="9">Grade 9</option><option value="10">Grade 10</option><option value="11">Grade 11</option><option value="12">Grade 12</option></select>
                        </div>
                        <div>
                            <label for="sped-filter" class="block text-sm font-medium text-gray-700 mb-1">Student Group</label>
                            <select id="sped-filter" class="filter-select w-full"><option value="all">All Students</option><option value="sped">Special Education</option><option value="gened">General Education</option><option value="tier2">Tier 2</option></select>
                        </div>
                        <div>
                            <label for="activity-filter" class="block text-sm font-medium text-gray-700 mb-1">Activity / Team</label>
                            <select id="activity-filter" class="filter-select w-full"><option value="all">All Activities</option></select>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <div id="kpi-total-students-card" class="card kpi-card"><div id="total-students" class="kpi-value">0</div><div class="kpi-label">Total Students</div></div>
                    <div id="kpi-ineligible-students-card" class="card kpi-card"><div id="ineligible-students" class="kpi-value">0</div><div class="kpi-label">Ineligible Students</div></div>
                    <div id="kpi-ineligibility-rate-card" class="card kpi-card"><div id="ineligibility-rate" class="kpi-value">0%</div><div class="kpi-label">Ineligibility Rate</div></div>
                    <div id="kpi-avg-absences-card" class="card kpi-card"><div id="avg-absences" class="kpi-value">0</div><div class="kpi-label">Avg. Absences (Periods)</div></div>
                    <div id="kpi-total-f-grades-card" class="card kpi-card"><div id="total-f-grades" class="kpi-value">0</div><div class="kpi-label">Total F Grades</div></div>
                    <div id="kpi-spartan-total-requests-card" class="card kpi-card"><div id="spartan-total-requests" class="kpi-value">0</div><div class="kpi-label">Spartan Hour Total Requests</div></div>
                    <div id="kpi-spartan-skipped-requests-card" class="card kpi-card"><div id="spartan-skipped-requests" class="kpi-value">0</div><div class="kpi-label">Spartan Hour Skipped Requests</div></div>
                    <div id="kpi-spartan-high-priority-requests-card" class="card kpi-card"><div id="spartan-high-priority-requests" class="kpi-value">0</div><div class="kpi-label">Spartan Hour High Priority Requests</div></div>
                    <div id="kpi-total-students-with-club-meetings-card" class="card kpi-card"><div id="total-students-with-club-meetings" class="kpi-value">0</div><div class="kpi-label">Club Participation</div></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Absence Breakdown by Type</h2><div class="chart-container"><canvas id="attendance-breakdown-chart"></canvas></div></div>
                    <div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Ineligibility Reasons</h2><div class="chart-container"><canvas id="ineligibility-chart"></canvas></div></div>
                    <div class="card lg:col-span-2"><h2 class="text-xl font-semibold text-gray-700 mb-4">Average Absences by Number of Failing Grades</h2><div class="chart-container"><canvas id="correlation-chart"></canvas></div></div>
                    <div class="card lg:col-span-2"><h2 class="text-xl font-semibold text-gray-700 mb-4">Performance: Activity vs. Non-Activity Students</h2><div class="chart-container"><canvas id="activity-chart"></canvas></div></div>
                    <div class="card lg:col-span-2"><h2 class="text-xl font-semibold text-gray-700 mb-4">Spartan Hour Request Breakdown</h2><div class="chart-container"><canvas id="spartan-hour-chart"></canvas></div></div>
                    <div class="card lg:col-span-2"><h2 class="text-xl font-semibold text-gray-700 mb-4">Club Participation by Grade</h2><div class="chart-container"><canvas id="club-meetings-by-grade-chart"></canvas></div></div>
                </div>
            </div>

            <div id="tab-content-snapshots" class="hidden">
                <div class="card mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Weekly Data Snapshots</h2>
                    <p class="text-gray-600 mb-6">Compare student data across different weeks to track trends and changes over time. Snapshots are automatically created every Monday at 6:00 AM.</p>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-blue-900 mb-2">Snapshot Management</h3>
                        <div class="flex flex-wrap gap-3">
                            <button id="create-snapshot-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">Create Snapshot Now</button>
                            <button id="setup-trigger-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">Setup Weekly Trigger</button>
                            <button id="refresh-snapshots-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-medium">Refresh List</button>
                        </div>
                        <div id="snapshot-status" class="mt-3 text-sm text-gray-700"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="snapshot1-select" class="block text-sm font-medium text-gray-700 mb-2">Compare from (older):</label>
                            <select id="snapshot1-select" class="filter-select w-full">
                                <option value="">Select a snapshot...</option>
                            </select>
                        </div>
                        <div>
                            <label for="snapshot2-select" class="block text-sm font-medium text-gray-700 mb-2">Compare to (newer):</label>
                            <select id="snapshot2-select" class="filter-select w-full">
                                <option value="">Select a snapshot...</option>
                                <option value="current">Current Data (Live)</option>
                            </select>
                        </div>
                    </div>

                    <div class="text-center mb-6">
                        <button id="compare-snapshots-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold text-lg disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>Compare Snapshots</button>
                    </div>

                    <div id="comparison-loading" class="hidden text-center py-8">
                        <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="mt-4 text-gray-600 font-medium">Comparing snapshots...</p>
                    </div>

                    <div id="comparison-results" class="hidden">
                        <div class="bg-gray-50 rounded-lg p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Comparison Summary</h3>
                            <div id="comparison-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-green-800 mb-3 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                                    Improvements
                                </h3>
                                <div id="improvements-list" class="max-h-96 overflow-y-auto"></div>
                            </div>

                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-red-800 mb-3 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                                    Declines
                                </h3>
                                <div id="declines-list" class="max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>

                        <div class="mt-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">All Changes</h3>
                            <div id="all-changes-list" class="max-h-96 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let allStudentData = [], charts = {}, studentListFilters = { search: '', grade: 'all', eligibility: 'all', activity: 'all' }, studentListSort = { key: 'studentName', order: 'asc' }, globalFilters = { grade: 'all', sped: 'all', activity: 'all' };
        let baselineKPIs = {};
        const tooltip = document.getElementById('tooltip');

        document.addEventListener('DOMContentLoaded', () => google.script.run.withSuccessHandler(initializeDashboard).withFailureHandler(handleError).getStudentData());
        
        function initializeDashboard(data) {
            allStudentData = data;
            baselineKPIs = calculateGroupKPIs(allStudentData);
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');
            
            populateFilters();
            setupGlobalFilters();
            setupStudentListFilters();
            setupSorting();
            setupTooltips();
            setupClearButtons();
            setupTabs();
            
            updateDashboard();
            applyStudentListFilters();
            updateSortIcons();
        }

        function setupTabs() {
            const tabStudents = document.getElementById('tab-students');
            const tabVisuals = document.getElementById('tab-visuals');
            const tabSnapshots = document.getElementById('tab-snapshots');
            const contentStudents = document.getElementById('tab-content-students');
            const contentVisuals = document.getElementById('tab-content-visuals');
            const contentSnapshots = document.getElementById('tab-content-snapshots');

            function switchTab(activeTab, activeContent) {
                [tabStudents, tabVisuals, tabSnapshots].forEach(tab => {
                    if (tab === activeTab) {
                        tab.classList.add('text-white', 'border-white');
                        tab.classList.remove('text-gray-400', 'border-transparent', 'hover:text-white', 'hover:border-gray-300');
                    } else {
                        tab.classList.remove('text-white', 'border-white');
                        tab.classList.add('text-gray-400', 'border-transparent', 'hover:text-white', 'hover:border-gray-300');
                    }
                });
                [contentStudents, contentVisuals, contentSnapshots].forEach(content => {
                    content.classList.toggle('hidden', content !== activeContent);
                });
            }

            tabStudents.addEventListener('click', () => switchTab(tabStudents, contentStudents));
            tabVisuals.addEventListener('click', () => switchTab(tabVisuals, contentVisuals));
            tabSnapshots.addEventListener('click', () => {
                switchTab(tabSnapshots, contentSnapshots);
                loadAvailableSnapshots();
            });

            setupSnapshotHandlers();
        }

        function handleError(error) { console.error("Dashboard Error:", error); document.getElementById('loading-state').innerHTML = `<p class="text-red-500 font-semibold">Error loading data.</p><p class="text-gray-600 mt-2">Please ensure the sheet '⭐Academics & Attendance Hub' exists and you have permission.</p>`; }

        function calculateGroupKPIs(data) {
            const totalStudents = data.length;
            if (totalStudents === 0) return { totalStudents: 0, ineligibleStudents: 0, ineligibilityRate: 0, avgAbsences: 0, totalFGrades: 0, spartanHourTotalRequests: 0, spartanHourSkippedRequests: 0, spartanHourReqsHighPriority: 0, totalStudentsWithClubMeetings: 0 };
            
            const ineligibleStudents = data.filter(s => s.ineligible).length;
            const totalAbsences = data.reduce((sum, s) => sum + s.totalAbsences, 0);
            const totalFGrades = data.reduce((sum, s) => sum + s.numFGrades, 0);
            const spartanHourTotalRequests = data.reduce((sum, s) => sum + s.spartanHourTotalRequests, 0);
            const spartanHourSkippedRequests = data.reduce((sum, s) => sum + s.spartanHourSkippedRequests, 0);
            const spartanHourReqsHighPriority = data.reduce((sum, s) => sum + s.spartanHourReqsHighPriority, 0);

            return {
                totalStudents: totalStudents,
                ineligibleStudents: ineligibleStudents,
                ineligibilityRate: (ineligibleStudents / totalStudents) * 100,
                avgAbsences: totalAbsences / totalStudents,
                totalFGrades: totalFGrades,
                spartanHourTotalRequests: spartanHourTotalRequests,
                spartanHourSkippedRequests: spartanHourSkippedRequests,
                spartanHourReqsHighPriority: spartanHourReqsHighPriority,
                totalStudentsWithClubMeetings: data.filter(s => s.totalClubMeetingsAttended > 0 || (s.clubsAttended && s.clubsAttended.trim() !== '')).length
            };
        }

        function populateFilters() {
            const activities = new Set(allStudentData.flatMap(s => (s.activity || '').split(',').map(a => a.trim()).filter(Boolean)));
            const sortedActivities = [...activities].sort();
            
            const globalActivityFilter = document.getElementById('activity-filter');
            sortedActivities.forEach(a => globalActivityFilter.innerHTML += `<option value="${a}">${a}</option>`);
            
            const studentActivityFilter = document.getElementById('student-activity-filter');
            studentActivityFilter.innerHTML = '<option value="all">Filter by Activity / Team</option>';
            sortedActivities.forEach(a => studentActivityFilter.innerHTML += `<option value="${a}">${a}</option>`);
        }

        function setupGlobalFilters() {
            document.getElementById('global-filters').addEventListener('change', e => {
                const { id, value } = e.target;
                if (id === 'grade-filter') globalFilters.grade = value;
                if (id === 'sped-filter') globalFilters.sped = value;
                if (id === 'activity-filter') globalFilters.activity = value;
                updateDashboard();
            });
        }
        
        function updateDashboard() {
            let data = allStudentData;
            if (globalFilters.grade !== 'all') data = data.filter(s => s.grade == globalFilters.grade);
            if (globalFilters.sped === 'sped') data = data.filter(s => s.caseManager);
            if (globalFilters.sped === 'gened') data = data.filter(s => !s.caseManager);
            if (globalFilters.sped === 'tier2') data = data.filter(s => s.tier2Interventions && s.tier2Interventions.trim() !== '');
            if (globalFilters.activity !== 'all') data = data.filter(s => (s.activity || '').split(',').map(a => a.trim()).includes(globalFilters.activity));
            
            renderKPIs(data);
            renderCharts(data);
        }

        function renderKPIs(data) {
            const filtersActive = Object.values(globalFilters).some(v => v !== 'all');
            const currentKPIs = calculateGroupKPIs(data);

            document.getElementById('total-students').textContent = currentKPIs.totalStudents;
            document.getElementById('ineligible-students').textContent = currentKPIs.ineligibleStudents;
            document.getElementById('ineligibility-rate').textContent = `${currentKPIs.ineligibilityRate.toFixed(1)}%`;
            document.getElementById('avg-absences').textContent = currentKPIs.avgAbsences.toFixed(1);
            document.getElementById('total-f-grades').textContent = currentKPIs.totalFGrades;
            document.getElementById('spartan-total-requests').textContent = currentKPIs.spartanHourTotalRequests;
            document.getElementById('spartan-skipped-requests').textContent = currentKPIs.spartanHourSkippedRequests;
            document.getElementById('spartan-high-priority-requests').textContent = currentKPIs.spartanHourReqsHighPriority;
            document.getElementById('total-students-with-club-meetings').textContent = currentKPIs.totalStudentsWithClubMeetings;

            const kpiCardInfo = [
                { id: 'kpi-ineligibility-rate-card', key: 'ineligibilityRate' },
                { id: 'kpi-avg-absences-card', key: 'avgAbsences' },
                { id: 'kpi-total-students-card', key: 'totalStudents' },
                { id: 'kpi-ineligible-students-card', key: 'ineligibleStudents' },
                { id: 'kpi-total-f-grades-card', key: 'totalFGrades' },
                { id: 'kpi-spartan-total-requests-card', key: 'spartanHourTotalRequests' },
                { id: 'kpi-spartan-skipped-requests-card', key: 'spartanHourSkippedRequests' },
                { id: 'kpi-spartan-high-priority-requests-card', key: 'spartanHourReqsHighPriority' },
                { id: 'kpi-total-students-with-club-meetings-card', key: 'totalStudentsWithClubMeetings' }
            ];

            kpiCardInfo.forEach(card => {
                const cardEl = document.getElementById(card.id);
                cardEl.classList.remove('clickable');
                if (filtersActive) {
                    cardEl.classList.add('clickable');
                    cardEl.dataset.tooltipKey = card.key;
                }
            });
        }

        function generateComparisonTooltip(kpiKey) {
            const formatter = (v) => {
                if (kpiKey.includes('Rate')) return `${v.toFixed(1)}%`;
                if (kpiKey.includes('Absences')) return v.toFixed(1);
                return v;
            };

            const { grade, sped, activity } = globalFilters;
            let comparisons = [];
            
            const currentData = allStudentData.filter(s => 
                (grade === 'all' || s.grade == grade) &&
                (sped === 'all' || (sped === 'sped' ? s.caseManager : (sped === 'gened' ? !s.caseManager : (sped === 'tier2' ? (s.tier2Interventions && s.tier2Interventions.trim() !== '') : true)))) &&
                (activity === 'all' || (s.activity || '').split(',').map(a => a.trim()).includes(activity))
            );
            const currentKpi = calculateGroupKPIs(currentData)[kpiKey];
            
            if (grade !== 'all' && (sped !== 'all' || activity !== 'all')) {
                const gradeAllSubgroupsData = allStudentData.filter(s => s.grade == grade);
                comparisons.push({ label: `Grade ${grade} (All Students)`, value: calculateGroupKPIs(gradeAllSubgroupsData)[kpiKey] });
            }
            if (sped !== 'all' && (grade !== 'all' || activity !== 'all')) {
                 const spedLabel = sped === 'sped' ? 'SPED' : (sped === 'gened' ? 'GenEd' : 'Tier 2');
                 const spedAllSubgroupsData = allStudentData.filter(s => (sped === 'sped' ? s.caseManager : (sped === 'gened' ? !s.caseManager : (sped === 'tier2' ? (s.tier2Interventions && s.tier2Interventions.trim() !== '') : true))));
                 comparisons.push({ label: `${spedLabel} (All Grades)`, value: calculateGroupKPIs(spedAllSubgroupsData)[kpiKey] });
            }
             if (activity !== 'all' && (grade !== 'all' || sped !== 'all')) {
                const activityAllSubgroupsData = allStudentData.filter(s => (s.activity || '').split(',').map(a => a.trim()).includes(activity));
                comparisons.push({ label: `${activity} (All Groups)`, value: calculateGroupKPIs(activityAllSubgroupsData)[kpiKey] });
            }

            let tooltipHtml = `<h4>Comparison Breakdowns</h4><ul><li><span>Current Filter:</span> <strong>${formatter(currentKpi)}</strong></li>`;
            
            const uniqueComparisons = _.uniqBy(comparisons, 'label').filter(c => Math.abs(c.value - currentKpi) > 0.01 || (c.value === 0 && currentKpi !== 0));
            
            uniqueComparisons.forEach(comp => {
                tooltipHtml += `<li><span>${comp.label}:</span> <strong>${formatter(comp.value)}</strong></li>`;
            });

            if(Math.abs(baselineKPIs[kpiKey] - currentKpi) > 0.01 || (baselineKPIs[kpiKey] === 0 && currentKpi !== 0)) {
              tooltipHtml += `<li><span>School-Wide:</span> <strong>${formatter(baselineKPIs[kpiKey])}</strong></li>`;
            }

            if (baselineKPIs[kpiKey] > 0 && kpiKey !== 'ineligibilityRate' && kpiKey !== 'avgAbsences') {
                const percentageOfTotal = (currentKpi / baselineKPIs[kpiKey]) * 100;
                tooltipHtml += `<li><span>% of Total:</span> <strong>${percentageOfTotal.toFixed(1)}%</strong></li>`;
            }
            
            tooltipHtml += `</ul>`;
            return tooltipHtml;
        }

        function renderCharts(data) {
            const chartColors = { blue: 'rgba(59, 130, 246, 0.7)', red: 'rgba(239, 68, 68, 0.7)', yellow: 'rgba(234, 179, 8, 0.7)', green: 'rgba(34, 197, 94, 0.7)', purple: 'rgba(139, 92, 246, 0.7)', orange: 'rgba(249, 115, 22, 0.7)', gray: 'rgba(107, 114, 128, 0.7)' };
            Object.values(charts).forEach(chart => chart.destroy());

            const totalUnexcused = data.reduce((sum, s) => sum + s.unexcusedAbsences, 0), totalTruancy = data.reduce((sum, s) => sum + s.truancyAbsences, 0), totalMedical = data.reduce((sum, s) => sum + s.medicalAbsences, 0), totalIllness = data.reduce((sum, s) => sum + s.illnessAbsences, 0);
            charts.attendance = new Chart(document.getElementById('attendance-breakdown-chart'), { type: 'doughnut', data: { labels: ['Unexcused', 'Truancy', 'Medical', 'Illness'], datasets: [{ data: [totalUnexcused, totalTruancy, totalMedical, totalIllness], backgroundColor: [chartColors.yellow, chartColors.red, chartColors.blue, chartColors.green] }] }, options: { maintainAspectRatio: false, responsive: true } });

            const failingOnly = data.filter(s => s.ineligible && s.isFailing && s.unservedDetention === 0).length, detentionOnly = data.filter(s => s.ineligible && !s.isFailing && s.unservedDetention > 0).length, both = data.filter(s => s.ineligible && s.isFailing && s.unservedDetention > 0).length;
            charts.ineligibility = new Chart(document.getElementById('ineligibility-chart'), { type: 'doughnut', data: { labels: ['Failing Only', 'Detention Only', 'Both'], datasets: [{ data: [failingOnly, detentionOnly, both], backgroundColor: [chartColors.red, chartColors.orange, chartColors.purple] }] }, options: { maintainAspectRatio: false, responsive: true } });

            const fGradeGroups = _.groupBy(data, 'numFGrades');
            const correlationLabels = Object.keys(fGradeGroups).sort((a,b) => a-b);
            const correlationData = correlationLabels.map(fCount => _.meanBy(fGradeGroups[fCount], 'totalAbsences') || 0);
            charts.correlation = new Chart(document.getElementById('correlation-chart'), { type: 'bar', data: { labels: correlationLabels.map(l => `${l} F's`), datasets: [{ label: 'Average Absences', data: correlationData, backgroundColor: chartColors.blue }] }, options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Average Absences (Periods)' } }, x: { title: { display: true, text: 'Number of Failing Grades' } } } } });
            
            const activityStudents = data.filter(s => s.activity), nonActivityStudents = data.filter(s => !s.activity);
            charts.activity = new Chart(document.getElementById('activity-chart'), { type: 'bar', data: { labels: ['Ineligibility Rate (%)', 'Avg Absences (Periods)'], datasets: [{ label: `In Activity (${activityStudents.length})`, data: [calculateGroupKPIs(activityStudents).ineligibilityRate, calculateGroupKPIs(activityStudents).avgAbsences], backgroundColor: chartColors.blue }, { label: `Not in Activity (${nonActivityStudents.length})`, data: [calculateGroupKPIs(nonActivityStudents).ineligibilityRate, calculateGroupKPIs(nonActivityStudents).avgAbsences], backgroundColor: chartColors.gray }] }, options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true } } } });

            // New Spartan Hour Chart
            const spartanHourLabels = ['Total Requests', 'Skipped Requests', 'High Priority Requests'];
            const spartanHourData = [
                data.reduce((sum, s) => sum + s.spartanHourTotalRequests, 0),
                data.reduce((sum, s) => sum + s.spartanHourSkippedRequests, 0),
                data.reduce((sum, s) => sum + s.spartanHourReqsHighPriority, 0)
            ];
            charts.spartanHour = new Chart(document.getElementById('spartan-hour-chart'), {
                type: 'bar',
                data: {
                    labels: spartanHourLabels,
                    datasets: [{
                        label: 'Number of Requests',
                        data: spartanHourData,
                        backgroundColor: [chartColors.blue, chartColors.red, chartColors.yellow]
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Requests' } },
                        x: { title: { display: true, text: 'Spartan Hour Metrics' } }
                    }
                }
            });

            // New Club Participation by Grade Chart
            const gradesForClubParticipation = [...new Set(data.map(s => s.grade))].sort((a, b) => a - b);
            const clubParticipationByGrade = gradesForClubParticipation.map(grade => {
                const studentsInGrade = data.filter(s => s.grade === grade);
                return studentsInGrade.filter(s => s.totalClubMeetingsAttended > 0 || (s.clubsAttended && s.clubsAttended.trim() !== '')).length;
            });
            charts.clubMeetingsByGrade = new Chart(document.getElementById('club-meetings-by-grade-chart'), {
                type: 'bar',
                data: {
                    labels: gradesForClubParticipation.map(g => `Grade ${g}`),
                    datasets: [{
                        label: 'Number of Students Participating',
                        data: clubParticipationByGrade,
                        backgroundColor: chartColors.green
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Students' } },
                        x: { title: { display: true, text: 'Grade Level' } }
                    }
                }
            });
        }
        
        function setupStudentListFilters() {
            document.getElementById('student-search').addEventListener('keyup', e => { studentListFilters.search = e.target.value.toLowerCase(); applyStudentListFilters(); });
            document.getElementById('student-activity-filter').addEventListener('change', e => { studentListFilters.activity = e.target.value; applyStudentListFilters(); });
            const gradeFilterContainer = document.getElementById('student-grade-filters');
            gradeFilterContainer.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { gradeFilterContainer.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); studentListFilters.grade = e.target.dataset.grade; applyStudentListFilters(); } });
            const eligibilityContainer = document.getElementById('student-eligibility-filters');
            eligibilityContainer.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { eligibilityContainer.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); studentListFilters.eligibility = e.target.dataset.status; applyStudentListFilters(); } });
        }
        
        function setupSorting() {
            document.querySelectorAll('thead th[data-sort]').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    if (studentListSort.key === sortKey) {
                        studentListSort.order = studentListSort.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        studentListSort.key = sortKey;
                        studentListSort.order = ['numFGrades', 'unservedDetention', 'totalAbsences', 'grade'].includes(sortKey) ? 'desc' : 'asc';
                    }
                    updateSortIcons();
                    applyStudentListFilters();
                });
            });
        }

        function updateSortIcons() {
            document.querySelectorAll('thead .sort-icon').forEach(icon => icon.textContent = '');
            const activeHeaderIcon = document.querySelector(`thead th[data-sort="${studentListSort.key}"] .sort-icon`);
            if (activeHeaderIcon) activeHeaderIcon.textContent = studentListSort.order === 'asc' ? ' ▲' : ' ▼';
        }

        function applyStudentListFilters() {
            let data = [...allStudentData];
            if (studentListFilters.grade !== 'all') data = data.filter(s => s.grade == studentListFilters.grade);
            if (studentListFilters.activity !== 'all') data = data.filter(s => (s.activity || '').split(',').map(a => a.trim()).includes(studentListFilters.activity));
            if (studentListFilters.search) data = data.filter(s => s.studentName.toLowerCase().includes(studentListFilters.search));
            if (studentListFilters.eligibility === 'eligible') data = data.filter(s => !s.ineligible);
            if (studentListFilters.eligibility === 'ineligible') data = data.filter(s => s.ineligible);

            const { key, order } = studentListSort;
            data.sort((a, b) => {
                let valA = a[key], valB = b[key];
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = b[key].toLowerCase(); }
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
            renderStudentList(data);
        }

        function renderStudentList(data) {
            const listBody = document.getElementById('student-list'), noResults = document.getElementById('no-students-message');
            if (data.length === 0) { listBody.innerHTML = ''; noResults.classList.remove('hidden'); return; }
            noResults.classList.add('hidden');
            listBody.innerHTML = data.map(s => `<tr class="${s.ineligible ? 'bg-red-50' : 'bg-white'}">
                <td class="px-6 py-4 text-sm text-gray-500 text-center">${s.grade}</td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${s.studentName}</div><div class="text-sm text-gray-500">ID: ${s.id}</div>${s.caseManager ? `<div class="text-xs font-semibold text-blue-600 cursor-pointer tooltip-trigger mt-1" data-student='${JSON.stringify(s)}' data-type="caseManager">Sp.Ed.</div>` : ''}${s.tier2Interventions || s.tier2Instructor ? `<div class="text-xs font-semibold text-purple-600 cursor-pointer tooltip-trigger mt-1" data-student='${JSON.stringify(s)}' data-type="tier2">Tier 2</div>` : ''}</td>
                <td class="px-6 py-4 text-xs text-gray-500">${s.activity || ''}</td>
                <td class="px-6 py-4 text-sm text-gray-500 text-center tooltip-trigger ${s.numFGrades > 0 ? 'border-2 border-red-700' : ''}" data-student='${JSON.stringify(s)}' data-type="failing">${s.numFGrades}</td>
                <td class="px-6 py-4 text-sm text-gray-500 text-center tooltip-trigger ${s.unservedDetention > 0 ? 'border-2 border-red-700' : ''}" data-student='${JSON.stringify(s)}' data-type="detention">${s.unservedDetention} hrs</td>
                <td class="px-6 py-4 text-sm text-gray-500 text-center tooltip-trigger" data-student='${JSON.stringify(s)}' data-type="absences">${s.totalAbsences}</td>
                <td class="px-6 py-4 text-sm text-gray-500 text-center tooltip-trigger" data-student='${JSON.stringify(s)}' data-type="spartanHour">${s.spartanHourTotalRequests} request${s.spartanHourTotalRequests === 1 ? '' : 's'}</td>
            </tr>`).join('');
        }
        
        function setupTooltips() {
            document.body.addEventListener('click', e => {
                const kpiCard = e.target.closest('.kpi-card.clickable');
                const studentCell = e.target.closest('.tooltip-trigger');

                if (kpiCard) {
                    e.stopPropagation();
                    const triggerId = kpiCard.id;
                    if (tooltip.style.display === 'block' && tooltip.dataset.triggerId === triggerId) {
                        hideTooltip(); return;
                    }
                    const key = kpiCard.dataset.tooltipKey;
                    const html = generateComparisonTooltip(key);
                    showTooltip(html, kpiCard, triggerId);
                } else if (studentCell) {
                    e.stopPropagation();
                    const triggerId = `${studentCell.parentElement.rowIndex}-${studentCell.cellIndex}`;
                    if (tooltip.style.display === 'block' && tooltip.dataset.triggerId === triggerId) {
                        hideTooltip(); return;
                    }
                    const student = JSON.parse(studentCell.dataset.student);
                    const type = studentCell.dataset.type;
                    let content = '';
                    if (type === 'failing' && student.numFGrades > 0) {
                        const classes = student.failingClasses.split('\n').filter(Boolean).map(c => `<li>${c}</li>`).join('');
                        let weeksHTML = '';
                        if (student.consecutiveWeeks > 0) {
                            weeksHTML = `<div style="margin-top: 10px;"><h4>Consecutive Weeks on D/F List</h4><p>${student.consecutiveWeeks}</p></div>`;
                        }
                        content = `<h4>Failing Classes</h4><ul style="list-style: inside;">${classes}</ul>${weeksHTML}`;
                    } else if (type === 'detention' && student.unservedDetention > 0) {
                        content = `<h4>Detention Details</h4><ul><li><span>Discipline:</span> <strong>${student.disciplineDetention} hrs</strong></li><li><span>Attendance:</span> <strong>${student.attendanceDetention} hrs</strong></li></ul>`;
                    } else if (type === 'absences') {
                        if (student.totalAbsences > 0) {
                            content = `<h4>Absence Details</h4><ul><li><span>Unexcused:</span> <strong>${student.unexcusedAbsences}</strong></li><li><span>Truancy:</span> <strong>${student.truancyAbsences}</strong></li><li><span>Medical:</span> <strong>${student.medicalAbsences}</strong></li><li><span>Illness:</span> <strong>${student.illnessAbsences}</strong></li></ul>`;
                        }
                        if (student.attendanceLetters) {
                            content += `<div style="margin-top: 10px;"><h4>Attendance Letters</h4><p>${student.attendanceLetters}</p></div>`;
                        }
                    } else if (type === 'spartanHour') {
                        content = `<h4>Spartan Hour Details</h4><ul><li><span>Total Requests:</span> <strong>${student.spartanHourTotalRequests}</strong></li><li><span>Most Recent:</span> <strong>${student.mostRecentSpartanHourRequest || 'N/A'}</strong></li><li><span>Skipped Requests:</span> <strong>${student.spartanHourSkippedRequests}</strong></li><li><span>High Priority:</span> <strong>${student.spartanHourReqsHighPriority}</strong></li></ul>`;
                        if (student.totalClubMeetingsAttended > 0 || (student.clubsAttended && student.clubsAttended.trim() !== '')) {
                            content += `<div style="margin-top: 10px;"><h4>Club Details</h4><ul><li><span>Meetings Attended:</span> <strong>${student.totalClubMeetingsAttended}</strong></li><li><span>Clubs:</span> <strong>${student.clubsAttended || 'N/A'}</strong></li></ul></div>`;
                        }
                    } else if (type === 'caseManager' && student.caseManager) {
                        content = `<h4>Case Manager</h4><p>${student.caseManager}</p>`;
                    } else if (type === 'tier2') {
                        let tier2Content = '<h4>Tier 2 Details</h4><ul>';
                        if (student.tier2Instructor) {
                            tier2Content += `<li><span>Instructor:</span> <strong>${student.tier2Instructor}</strong></li>`;
                        }
                        if (student.tier2Interventions) {
                            tier2Content += `<li><span>Intervention:</span> <strong>${student.tier2Interventions}</strong></li>`;
                        }
                        tier2Content += '</ul>';
                        content = tier2Content;
                    }
                    if(content) showTooltip(content, studentCell, triggerId);
                } else if (tooltip.style.display === 'block') {
                    hideTooltip();
                }
            });
        }

        function showTooltip(html, element, triggerId) {
            tooltip.innerHTML = html;
            tooltip.style.display = 'block';
            tooltip.dataset.triggerId = triggerId;
            const rect = element.getBoundingClientRect();
            let top = rect.bottom + window.scrollY + 5;
            let left = rect.left + window.scrollX;
            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
            const tooltipRect = tooltip.getBoundingClientRect();
            if (tooltipRect.right > window.innerWidth) tooltip.style.left = `${window.innerWidth - tooltipRect.width - 20}px`;
            if (tooltipRect.bottom > (window.innerHeight - 20) ) tooltip.style.top = `${rect.top + window.scrollY - tooltipRect.height - 5}px`;
            setTimeout(() => { tooltip.style.opacity = 1; }, 10);
        }

        function hideTooltip() {
            tooltip.style.opacity = 0;
            setTimeout(() => { 
                tooltip.style.display = 'none'; 
                tooltip.removeAttribute('data-trigger-id');
            }, 200);
        }

        function setupClearButtons() {
            document.getElementById('reset-global-filters-btn').addEventListener('click', () => {
                document.getElementById('grade-filter').value = 'all';
                document.getElementById('sped-filter').value = 'all';
                document.getElementById('activity-filter').value = 'all';
                globalFilters = { grade: 'all', sped: 'all', activity: 'all' };
                updateDashboard();
            });

            document.getElementById('reset-student-filters-btn').addEventListener('click', () => {
                document.getElementById('student-search').value = '';
                document.getElementById('student-activity-filter').value = 'all';
                
                document.querySelector('#student-grade-filters .filter-btn.active').classList.remove('active');
                document.querySelector('#student-grade-filters .filter-btn[data-grade="all"]').classList.add('active');
                
                document.querySelector('#student-eligibility-filters .filter-btn.active').classList.remove('active');
                document.querySelector('#student-eligibility-filters .filter-btn[data-status="all"]').classList.add('active');
                
                studentListFilters = { search: '', grade: 'all', eligibility: 'all', activity: 'all' };
                applyStudentListFilters();
            });
        }

        // ===============================================================
        // SNAPSHOT MANAGEMENT FUNCTIONS
        // ===============================================================

        function setupSnapshotHandlers() {
            const createBtn = document.getElementById('create-snapshot-btn');
            const setupTriggerBtn = document.getElementById('setup-trigger-btn');
            const refreshBtn = document.getElementById('refresh-snapshots-btn');
            const compareBtn = document.getElementById('compare-snapshots-btn');
            const snapshot1Select = document.getElementById('snapshot1-select');
            const snapshot2Select = document.getElementById('snapshot2-select');

            createBtn.addEventListener('click', createSnapshot);
            setupTriggerBtn.addEventListener('click', setupWeeklyTrigger);
            refreshBtn.addEventListener('click', loadAvailableSnapshots);
            compareBtn.addEventListener('click', compareSelectedSnapshots);

            // Enable compare button only when both selections are made
            [snapshot1Select, snapshot2Select].forEach(select => {
                select.addEventListener('change', () => {
                    const canCompare = snapshot1Select.value && snapshot2Select.value;
                    compareBtn.disabled = !canCompare;
                });
            });
        }

        function loadAvailableSnapshots() {
            const statusDiv = document.getElementById('snapshot-status');
            statusDiv.innerHTML = '<span class="text-gray-600">Loading snapshots...</span>';

            google.script.run
                .withSuccessHandler(populateSnapshotSelects)
                .withFailureHandler(err => {
                    statusDiv.innerHTML = `<span class="text-red-600">Error loading snapshots: ${err.message}</span>`;
                })
                .getAvailableSnapshots();
        }

        function populateSnapshotSelects(snapshots) {
            const snapshot1Select = document.getElementById('snapshot1-select');
            const snapshot2Select = document.getElementById('snapshot2-select');
            const statusDiv = document.getElementById('snapshot-status');

            // Clear existing options except the first one
            snapshot1Select.innerHTML = '<option value="">Select a snapshot...</option>';
            snapshot2Select.innerHTML = '<option value="">Select a snapshot...</option><option value="current">Current Data (Live)</option>';

            if (snapshots.length === 0) {
                statusDiv.innerHTML = '<span class="text-yellow-600">No snapshots available. Create your first snapshot to get started!</span>';
                return;
            }

            snapshots.forEach(snapshot => {
                const option1 = document.createElement('option');
                option1.value = snapshot.name;
                option1.textContent = snapshot.displayName;
                snapshot1Select.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = snapshot.name;
                option2.textContent = snapshot.displayName;
                snapshot2Select.appendChild(option2);
            });

            statusDiv.innerHTML = `<span class="text-green-600">Found ${snapshots.length} snapshot(s). Select two to compare.</span>`;
        }

        function createSnapshot() {
            const statusDiv = document.getElementById('snapshot-status');
            const createBtn = document.getElementById('create-snapshot-btn');

            createBtn.disabled = true;
            statusDiv.innerHTML = '<span class="text-blue-600">Creating snapshot...</span>';

            google.script.run
                .withSuccessHandler(snapshotName => {
                    statusDiv.innerHTML = `<span class="text-green-600">✓ Snapshot created successfully: ${snapshotName}</span>`;
                    createBtn.disabled = false;
                    loadAvailableSnapshots();
                })
                .withFailureHandler(err => {
                    statusDiv.innerHTML = `<span class="text-red-600">Error creating snapshot: ${err.message}</span>`;
                    createBtn.disabled = false;
                })
                .createWeeklySnapshot();
        }

        function setupWeeklyTrigger() {
            const statusDiv = document.getElementById('snapshot-status');
            const setupBtn = document.getElementById('setup-trigger-btn');

            setupBtn.disabled = true;
            statusDiv.innerHTML = '<span class="text-blue-600">Setting up weekly trigger...</span>';

            google.script.run
                .withSuccessHandler(() => {
                    statusDiv.innerHTML = '<span class="text-green-600">✓ Weekly trigger set up successfully! Snapshots will be created every Monday at 6:00 AM.</span>';
                    setupBtn.disabled = false;
                })
                .withFailureHandler(err => {
                    statusDiv.innerHTML = `<span class="text-red-600">Error setting up trigger: ${err.message}</span>`;
                    setupBtn.disabled = false;
                })
                .setupWeeklySnapshotTrigger();
        }

        function compareSelectedSnapshots() {
            const snapshot1 = document.getElementById('snapshot1-select').value;
            const snapshot2 = document.getElementById('snapshot2-select').value;

            if (!snapshot1 || !snapshot2) {
                alert('Please select two snapshots to compare.');
                return;
            }

            const loadingDiv = document.getElementById('comparison-loading');
            const resultsDiv = document.getElementById('comparison-results');
            const compareBtn = document.getElementById('compare-snapshots-btn');

            compareBtn.disabled = true;
            loadingDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');

            google.script.run
                .withSuccessHandler(displayComparisonResults)
                .withFailureHandler(err => {
                    loadingDiv.classList.add('hidden');
                    compareBtn.disabled = false;
                    alert(`Error comparing snapshots: ${err.message}`);
                })
                .compareSnapshots(snapshot1, snapshot2);
        }

        function displayComparisonResults(comparison) {
            const loadingDiv = document.getElementById('comparison-loading');
            const resultsDiv = document.getElementById('comparison-results');
            const compareBtn = document.getElementById('compare-snapshots-btn');

            loadingDiv.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
            compareBtn.disabled = false;

            // Calculate aggregate statistics by category
            const aggregateStats = {
                totalAcademicChanges: 0,
                totalDetentionChanges: 0,
                totalAbsenceChanges: 0,
                totalSpartanChanges: 0,
                totalEngagementChanges: 0
            };

            comparison.changes.forEach(student => {
                Object.values(student.changes).forEach(change => {
                    if (change.category === 'academic') aggregateStats.totalAcademicChanges++;
                    if (change.category === 'detention') aggregateStats.totalDetentionChanges++;
                    if (change.category === 'absence') aggregateStats.totalAbsenceChanges++;
                    if (change.category === 'spartan') aggregateStats.totalSpartanChanges++;
                    if (change.category === 'engagement') aggregateStats.totalEngagementChanges++;
                });
            });

            // Populate summary
            const summaryDiv = document.getElementById('comparison-summary');
            summaryDiv.innerHTML = `
                <div class="bg-white rounded-lg p-4 shadow">
                    <div class="text-2xl font-bold text-green-700">${comparison.summary.studentsImproved}</div>
                    <div class="text-sm text-gray-600">Students Improved</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow">
                    <div class="text-2xl font-bold text-red-700">${comparison.summary.studentsDeclined}</div>
                    <div class="text-sm text-gray-600">Students Declined</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow">
                    <div class="text-2xl font-bold text-gray-800">${comparison.summary.studentsWithChanges}</div>
                    <div class="text-sm text-gray-600">Total with Changes</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow">
                    <div class="text-2xl font-bold text-gray-800">${comparison.summary.totalStudents2}</div>
                    <div class="text-sm text-gray-600">Total Students</div>
                </div>
                <div class="bg-blue-50 rounded-lg p-3 shadow col-span-full">
                    <div class="text-xs font-semibold text-blue-900 mb-2">Changes by Category:</div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">
                        <div><span class="font-medium text-purple-700">${aggregateStats.totalAcademicChanges}</span> Academic</div>
                        <div><span class="font-medium text-orange-700">${aggregateStats.totalDetentionChanges}</span> Detention</div>
                        <div><span class="font-medium text-red-700">${aggregateStats.totalAbsenceChanges}</span> Attendance</div>
                        <div><span class="font-medium text-indigo-700">${aggregateStats.totalSpartanChanges}</span> Spartan Hour</div>
                        <div><span class="font-medium text-green-700">${aggregateStats.totalEngagementChanges}</span> Engagement</div>
                    </div>
                </div>
            `;

            // Populate improvements
            const improvementsList = document.getElementById('improvements-list');
            if (comparison.improvements.length === 0) {
                improvementsList.innerHTML = '<p class="text-gray-500 text-sm">No improvements detected.</p>';
            } else {
                improvementsList.innerHTML = comparison.improvements.map(student => {
                    const changes = formatChanges(student.changes);
                    return `
                        <div class="bg-white rounded p-3 mb-2 border border-green-200">
                            <div class="font-semibold text-sm">${student.studentName}</div>
                            <div class="text-xs text-gray-600">Grade ${student.grade}</div>
                            <div class="text-xs mt-1">${changes}</div>
                        </div>
                    `;
                }).join('');
            }

            // Populate declines
            const declinesList = document.getElementById('declines-list');
            if (comparison.declines.length === 0) {
                declinesList.innerHTML = '<p class="text-gray-500 text-sm">No declines detected.</p>';
            } else {
                declinesList.innerHTML = comparison.declines.map(student => {
                    const changes = formatChanges(student.changes);
                    return `
                        <div class="bg-white rounded p-3 mb-2 border border-red-200">
                            <div class="font-semibold text-sm">${student.studentName}</div>
                            <div class="text-xs text-gray-600">Grade ${student.grade}</div>
                            <div class="text-xs mt-1">${changes}</div>
                        </div>
                    `;
                }).join('');
            }

            // Populate all changes
            const allChangesList = document.getElementById('all-changes-list');
            if (comparison.changes.length === 0) {
                allChangesList.innerHTML = '<p class="text-gray-500 text-sm">No changes detected between the selected snapshots.</p>';
            } else {
                allChangesList.innerHTML = comparison.changes.map(student => {
                    const changes = formatChanges(student.changes);
                    return `
                        <div class="bg-white rounded p-3 mb-2 border border-gray-300">
                            <div class="font-semibold text-sm">${student.studentName}</div>
                            <div class="text-xs text-gray-600">Grade ${student.grade}</div>
                            <div class="text-xs mt-1">${changes}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function formatChanges(changes) {
            // Group changes by category
            const categories = {
                academic: [],
                detention: [],
                absence: [],
                spartan: [],
                engagement: [],
                tracking: []
            };

            // Field display names
            const fieldNames = {
                numFGrades: 'Failing Classes',
                unservedDetention: 'Unserved Detention',
                totalDetention: 'Total Detention',
                disciplineDetention: 'Discipline Detention',
                attendanceDetention: 'Attendance Detention',
                totalAbsences: 'Total Absences',
                unexcusedAbsences: 'Unexcused Absences',
                unexcusedTardies: 'Unexcused Tardies',
                medicalAbsences: 'Medical Absences',
                illnessAbsences: 'Illness Absences',
                truancyAbsences: 'Truancy Absences',
                spartanHourTotalRequests: 'Spartan Hour Requests',
                spartanHourSkippedRequests: 'Skipped Sessions',
                spartanHourReqsHighPriority: 'High Priority Requests',
                totalClubMeetingsAttended: 'Club Meetings',
                consecutiveWeeks: 'Consecutive Weeks on D/F List'
            };

            // Sort changes into categories
            Object.keys(changes).forEach(field => {
                const change = changes[field];
                const category = change.category || 'other';
                const displayName = fieldNames[field] || field;

                // Determine color based on whether it's an improvement
                let color, arrow;
                if (field === 'totalClubMeetingsAttended') {
                    // Higher is better for engagement
                    color = change.change > 0 ? 'text-green-600' : 'text-red-600';
                    arrow = change.change > 0 ? '↑' : '↓';
                } else {
                    // Lower is better for most metrics
                    color = change.change < 0 ? 'text-green-600' : 'text-red-600';
                    arrow = change.change < 0 ? '↓' : '↑';
                }

                const html = `<span class="${color}">${displayName}: ${change.old} ${arrow} ${change.new}</span>`;

                if (categories[category]) {
                    categories[category].push(html);
                }
            });

            // Build HTML output with categories
            const sections = [];

            if (categories.academic.length > 0) {
                sections.push(`<div class="mb-1"><strong class="text-xs text-gray-700">Academic:</strong> ${categories.academic.join(', ')}</div>`);
            }
            if (categories.detention.length > 0) {
                sections.push(`<div class="mb-1"><strong class="text-xs text-gray-700">Detention:</strong> ${categories.detention.join(', ')}</div>`);
            }
            if (categories.absence.length > 0) {
                sections.push(`<div class="mb-1"><strong class="text-xs text-gray-700">Attendance:</strong> ${categories.absence.join(', ')}</div>`);
            }
            if (categories.spartan.length > 0) {
                sections.push(`<div class="mb-1"><strong class="text-xs text-gray-700">Spartan Hour:</strong> ${categories.spartan.join(', ')}</div>`);
            }
            if (categories.engagement.length > 0) {
                sections.push(`<div class="mb-1"><strong class="text-xs text-gray-700">Engagement:</strong> ${categories.engagement.join(', ')}</div>`);
            }
            if (categories.tracking.length > 0) {
                sections.push(`<div class="mb-1"><strong class="text-xs text-gray-700">Progress:</strong> ${categories.tracking.join(', ')}</div>`);
            }

            return sections.join('');
        }

    </script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
</body>
</html>

